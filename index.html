<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Explozill - Carte</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: 'Nunito', -apple-system, sans-serif; }
        #map { width: 100%; height: 100%; z-index: 1; }

        #score-badge {
            position: fixed; top: 10px; right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 6px 12px;
            border-radius: 16px; z-index: 1000;
            font-size: 12px; font-weight: 700;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        #route-title {
            position: fixed; top: 10px; left: 10px; right: 90px;
            background: rgba(255,255,255,0.95);
            padding: 6px 12px; border-radius: 10px; z-index: 1000;
            font-size: 11px; font-weight: 700; color: #1a1a2e;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        #ai-badge {
            position: fixed; top: 42px; left: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; padding: 3px 10px; border-radius: 8px; z-index: 1000;
            font-size: 9px; font-weight: 700; display: none;
        }
        #etape-info {
            position: fixed; bottom: 15px; left: 15px; right: 15px;
            background: white; border-radius: 14px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 999; display: none; cursor: pointer;
        }
        #etape-info-title { font-size: 13px; font-weight: 800; color: #1a1a2e; margin-bottom: 3px; }
        #etape-info-subtitle { font-size: 11px; color: #667eea; font-weight: 600; }
        #etape-info-arrow { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #667eea; }

        /* MOONSKY */
        .moonsky-row {
            display: flex; align-items: flex-end; gap: 0;
            width: 100%; max-width: 340px; margin-bottom: 14px;
        }
        .moonsky-img {
            width: 72px; height: 72px; object-fit: contain; flex-shrink: 0;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.35));
        }
        .moonsky-bubble {
            position: relative;
            background: rgba(255,255,255,0.13);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.22);
            border-radius: 14px;
            padding: 10px 14px;
            font-size: 13px; font-weight: 600; line-height: 1.55;
            color: white; flex: 1; margin-left: -6px;
            min-height: 44px;
        }
        .moonsky-bubble::before {
            content: ''; position: absolute;
            left: -8px; bottom: 16px;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 8px solid rgba(255,255,255,0.13);
        }

        /* OVERLAY */
        #overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 2000; display: none; flex-direction: column;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .screen {
            min-height: 100%; width: 100%;
            background: linear-gradient(160deg, #0a1628 0%, #1a237e 40%, #283593 70%, #0d47a1 100%);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 30px 24px; text-align: center; color: white;
        }
        .screen.hidden { display: none; }
        .step-badge, .type-badge {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 4px 14px; border-radius: 20px;
            font-size: 10px; font-weight: 700;
            letter-spacing: 1px; text-transform: uppercase;
            margin-bottom: 14px;
        }
        .lieu-nom { font-size: 24px; font-weight: 900; margin-bottom: 16px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); line-height: 1.2; }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; border: none;
            padding: 14px 40px; border-radius: 30px;
            font-size: 16px; font-weight: 800;
            font-family: 'Nunito', sans-serif; cursor: pointer;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
            letter-spacing: 0.5px;
        }
        .btn-primary:active { transform: scale(0.96); }
        .btn-green {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white; border: none;
            padding: 14px 40px; border-radius: 30px;
            font-size: 15px; font-weight: 800;
            font-family: 'Nunito', sans-serif; cursor: pointer;
            box-shadow: 0 4px 15px rgba(40,167,69,0.4);
        }
        .btn-ghost {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            color: white; padding: 12px 30px; border-radius: 30px;
            font-size: 14px; font-weight: 700;
            font-family: 'Nunito', sans-serif; cursor: pointer;
        }

        /* QUIZ */
        .quiz-question { font-size: 17px; font-weight: 800; text-align: center; margin-bottom: 18px; line-height: 1.4; max-width: 320px; }
        .quiz-answers { width: 100%; max-width: 320px; }
        .quiz-answer-btn {
            display: block; width: 100%;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.25);
            color: white; padding: 12px 16px; border-radius: 12px;
            font-size: 14px; font-weight: 600;
            font-family: 'Nunito', sans-serif;
            cursor: pointer; margin-bottom: 10px; text-align: left;
            transition: all 0.2s;
        }
        .quiz-answer-btn:active { transform: scale(0.97); }
        .quiz-answer-btn.correct { background: rgba(40,167,69,0.3); border-color: #28a745; }
        .quiz-answer-btn.wrong { background: rgba(220,53,69,0.3); border-color: #dc3545; }
        .hint-box {
            margin-top: 12px; background: rgba(255,255,255,0.08);
            border-radius: 10px; padding: 10px 14px;
            font-size: 12px; opacity: 0.8; max-width: 320px;
        }
        .hint-toggle {
            background: none; border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.7);
            padding: 6px 16px; border-radius: 16px;
            font-size: 11px; font-weight: 600;
            font-family: 'Nunito', sans-serif; cursor: pointer; margin-top: 10px;
        }

        /* PHOTO */
        .photo-consigne { font-size: 16px; font-weight: 700; margin-bottom: 16px; line-height: 1.5; max-width: 300px; }

        /* RESULT */
        .result-emoji { font-size: 50px; margin-bottom: 10px; }
        .result-title { font-size: 22px; font-weight: 900; margin-bottom: 6px; }
        .result-points {
            font-size: 32px; font-weight: 900;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .conclusion-score {
            font-size: 42px; font-weight: 900;
            background: linear-gradient(135deg, #ffd700, #ff6b35);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .conclusion-text { font-size: 14px; opacity: 0.9; line-height: 1.6; max-width: 300px; margin-bottom: 20px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .anim { animation: fadeIn 0.4s ease-out; }
        @keyframes bounceIn { 0%{transform:scale(0.3);opacity:0}50%{transform:scale(1.05)}70%{transform:scale(0.95)}100%{transform:scale(1);opacity:1} }
        .bounce { animation: bounceIn 0.6s ease-out; }
        @keyframes scoreUp { 0%{transform:scale(1)}50%{transform:scale(1.4)}100%{transform:scale(1)} }
        .score-up { animation: scoreUp 0.6s ease; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="route-title"></div>
<div id="ai-badge">‚ú® G√âN√âR√â PAR IA</div>
<div id="score-badge">üêæ <span id="score-value">0</span> pts</div>

<div id="etape-info" onclick="openEtape()">
    <div id="etape-info-title"></div>
    <div id="etape-info-subtitle">APPUYER POUR COMMENCER ‚Üí</div>
    <div id="etape-info-arrow">‚Ä∫</div>
</div>

<!-- ========== OVERLAY ========== -->
<div id="overlay">

    <!-- INTRO -->
    <div id="scr-intro" class="screen anim">
        <div class="step-badge" id="intro-badge">√âTAPE 1/3</div>
        <div class="lieu-nom" id="intro-lieu"></div>
        <div class="moonsky-row">
            <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310419663030501819/OzdLzpGilysdjrSQ.png" class="moonsky-img" alt="Moonsky"/>
            <div class="moonsky-bubble" id="intro-bubble"></div>
        </div>
        <button class="btn-primary" onclick="showDefi()">Lancer le d√©fi üéØ</button>
    </div>

    <!-- QUIZ -->
    <div id="scr-quiz" class="screen hidden">
        <div class="type-badge" id="quiz-badge">üß© QUIZ</div>
        <div class="quiz-question" id="quiz-question"></div>
        <div class="quiz-answers" id="quiz-answers"></div>
        <button class="hint-toggle" onclick="toggleHint()">üí° Indice</button>
        <div class="hint-box" id="quiz-hint" style="display:none"></div>
    </div>

    <!-- PHOTO / OBSERVATION -->
    <div id="scr-photo" class="screen hidden">
        <div class="type-badge" id="photo-badge">üì∏ D√âFI PHOTO</div>
        <div class="moonsky-row" style="justify-content:center">
            <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310419663030501819/OzdLzpGilysdjrSQ.png" class="moonsky-img" alt="Moonsky"/>
            <div class="moonsky-bubble" id="photo-bubble"></div>
        </div>
        <div class="photo-consigne" id="photo-consigne"></div>
        <button class="btn-green" onclick="photoOk()">‚úÖ C'est fait !</button>
    </div>

    <!-- R√âSULTAT -->
    <div id="scr-result" class="screen hidden">
        <div class="result-emoji" id="res-emoji">üéâ</div>
        <div class="result-title" id="res-title">Bravo !</div>
        <div class="result-points" id="res-points">+100 pts</div>
        <div class="moonsky-row" style="justify-content:center">
            <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310419663030501819/OzdLzpGilysdjrSQ.png" class="moonsky-img" alt="Moonsky"/>
            <div class="moonsky-bubble" id="res-bubble"></div>
        </div>
        <button class="btn-primary" id="btn-next" onclick="nextStep()">√âtape suivante ‚Üí</button>
    </div>

    <!-- CONCLUSION -->
    <div id="scr-end" class="screen hidden" style="background:linear-gradient(160deg,#0a1628 0%,#0d47a1 50%,#1565c0 100%)">
        <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310419663030501819/OzdLzpGilysdjrSQ.png" class="moonsky-img bounce" style="width:90px;height:90px;margin-bottom:10px" alt="Moonsky"/>
        <div class="result-title" style="margin-top:8px">Parcours termin√© !</div>
        <div class="conclusion-score" id="end-score">0/0</div>
        <div class="moonsky-row" style="justify-content:center">
            <div class="moonsky-bubble" id="end-bubble" style="margin-left:0"></div>
        </div>
        <button class="btn-ghost" onclick="backToMap()">üó∫Ô∏è Retour √† la carte</button>
    </div>
</div>

<script>
// ============================================================
// EXPLOZILL v5 ‚Äì Moonsky parle !
// ============================================================
var WEBHOOK = 'https://hook.eu2.make.com/sazwwf4twy6hcfu3qckrqrl4v7hubdbl';
var DEFAULTS = {duree:'Expresso',mobilite:'A pied',theme:'D√©couverte',pauses:'Non',mood:'Aventurier',compo:'Duo',ville:'Tours',lat:'47.3942',lng:'0.6885'};

var DEMO = {
 titre:"Flash Tour(s) : les pierres parlent vite", ville:"Tours",
 introduction:"Salut aventurier ! Moi c'est Moonsky, ton compagnon d'exploration. Pr√™t √† d√©couvrir Tours ?",
 etapes:[
  {ordre:1,lieu_nom:"Place Plumereau",latitude:47.3948,longitude:0.6833,
   narration_arrivee:"Te voil√† sur la Place Plumereau, c≈ìur vibrant du Vieux Tours ! Regarde ces fa√ßades √† colombages... Chacune raconte des si√®cles d'histoire !",
   interaction:{type_interaction:"quiz",question:"Combien de maisons √† colombages peux-tu rep√©rer autour de la place ?",reponses:["8","12","15","20"],bonne_reponse:1,indice:"Concentre-toi sur les fa√ßades avec des poutres en bois visibles."},
   narration_reussite:"Bien vu ! Ton regard d'aventurier capte la g√©om√©trie cach√©e du d√©cor. Tu commences fort !",
   narration_echec:"Pas grave, recalibre ton ≈ìil ! La suite t'attend et je suis s√ªr que tu vas te rattraper.",
   points:100},
  {ordre:2,lieu_nom:"Cath√©drale Saint-Gatien",latitude:47.3955,longitude:0.6944,
   narration_arrivee:"La Cath√©drale Saint-Gatien se dresse devant toi. Plusieurs si√®cles de construction ont donn√© ce m√©lange de styles unique. Impressionnant, non ?",
   interaction:{type_interaction:"quiz",question:"En quelle ann√©e a d√©but√© la construction de la cath√©drale Saint-Gatien ?",reponses:["1170","1236","1306","1425"],bonne_reponse:1,indice:"C'est au XIIIe si√®cle, sous le r√®gne de Saint Louis."},
   narration_reussite:"Exact ! Tu ma√Ætrises l'histoire comme un vrai pisteur urbain !",
   narration_echec:"La bonne r√©ponse √©tait 1236. Retiens-la, √ßa pourrait resservir !",
   points:100},
  {ordre:3,lieu_nom:"Pont Wilson",latitude:47.3930,longitude:0.6880,
   narration_arrivee:"Le Pont Wilson, surnomm√© le Pont de Pierre, enjambe la Loire avec √©l√©gance. C'est l'un des symboles de Tours !",
   interaction:{type_interaction:"photo",consigne:"Prends une photo du pont avec la Loire en arri√®re-plan. Essaie de capturer au moins une arche compl√®te !",indice:"Place-toi sur la rive nord pour avoir le meilleur angle."},
   narration_reussite:"Superbe clich√© ! Tu as l'≈ìil du photographe urbain. Moonsky approuve !",
   narration_echec:"Pas de souci, l'important c'est d'avoir profit√© de la vue !",
   points:100}
 ],
 conclusion:"Bravo aventurier ! Tu as explor√© le c≈ìur de Tours avec brio. Moonsky est fier de toi !"
};

var map, markers=[], polyline, parcours=null, step=0, score=0, loaded=false;

map = L.map('map',{center:[47.3942,0.6885],zoom:15,zoomControl:false});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'}).addTo(map);

function getP(){var p=JSON.parse(JSON.stringify(DEFAULTS));try{new URLSearchParams(location.search).forEach(function(v,k){if(v)p[k]=v})}catch(e){}try{if(location.hash){new URLSearchParams(location.hash.substring(1)).forEach(function(v,k){if(v)p[k]=v})}}catch(e){}return p}

function callWH(ok){var p=getP(),u=WEBHOOK+'?duree='+enc(p.duree)+'&mobilite='+enc(p.mobilite)+'&theme='+enc(p.theme)+'&pauses='+enc(p.pauses)+'&mood='+enc(p.mood)+'&compo='+enc(p.compo)+'&ville='+enc(p.ville)+'&lat='+enc(p.lat)+'&lng='+enc(p.lng);var x=new XMLHttpRequest();x.open('GET',u,true);x.timeout=120000;x.onload=function(){if(x.status===200&&x.responseText&&x.responseText!=='Accepted'){try{var d=parse(x.responseText);if(d&&d.etapes&&d.etapes.length>0){if(ok)ok();load(d,true);return}}catch(e){}}};x.onerror=x.ontimeout=function(){};x.send()}
function enc(s){return encodeURIComponent(s)}

function parse(r){if(typeof r==='object'&&r)return norm(r);if(typeof r==='string'){var s=r.trim().replace(/\s*du module OpenAI.*$/s,'').replace(/\s*du module ChatGPT.*$/s,'');try{return norm(JSON.parse(s))}catch(e){}var i=s.indexOf('{'),j=s.lastIndexOf('}');if(i!==-1&&j>i){try{return norm(JSON.parse(s.substring(i,j+1)))}catch(e){}}}return null}
function norm(d){if(d.parcours)d=d.parcours;if(d.route)d=d.route;if(d.result){if(typeof d.result==='string'){try{d=JSON.parse(d.result)}catch(e){return null}}else d=d.result}if(!d.etapes&&d.waypoints)d.etapes=d.waypoints;if(!d.etapes&&d.steps)d.etapes=d.steps;if(d.etapes&&Array.isArray(d.etapes)){d.etapes=d.etapes.map(function(e,i){return{ordre:e.ordre||(i+1),lieu_nom:e.lieu_nom||e.name||e.lieu||e.title||('√âtape '+(i+1)),latitude:parseFloat(e.latitude||e.lat),longitude:parseFloat(e.longitude||e.lng||e.lon),narration_arrivee:e.narration_arrivee||e.narration||e.description||'',interaction:normI(e.interaction||e),narration_reussite:e.narration_reussite||e.success_text||'Bravo !',narration_echec:e.narration_echec||e.failure_text||'Pas tout √† fait...',points:e.points||100}})}return d}
function normI(i){if(!i)return{type_interaction:'observation',consigne:'Observe bien cet endroit !'};if(i.type_interaction)return i;if(i.question&&i.reponses)return{type_interaction:'quiz',question:i.question,reponses:i.reponses,bonne_reponse:i.bonne_reponse||0,indice:i.indice||''};if(i.consigne)return{type_interaction:i.type||'observation',consigne:i.consigne,indice:i.indice||''};return{type_interaction:'observation',consigne:'Observe bien cet endroit !'}}

function ico(n,a){return L.divIcon({className:'x',iconSize:[34,34],iconAnchor:[17,17],html:'<div style="width:34px;height:34px;border-radius:50%;background:'+(a?'linear-gradient(135deg,#667eea,#764ba2)':'#bbb')+';color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;box-shadow:0 2px 8px rgba(0,0,0,.3);border:3px solid #fff;font-family:Nunito,sans-serif">'+n+'</div>'})}
function doneIco(){return L.divIcon({className:'x',iconSize:[34,34],iconAnchor:[17,17],html:'<div style="width:34px;height:34px;border-radius:50%;background:#28a745;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;box-shadow:0 2px 8px rgba(0,0,0,.3);border:3px solid #fff">‚úì</div>'})}

// ============ MOONSKY PARLE ============
function speak(id, txt, cb){
    var el=document.getElementById(id); el.textContent='';
    var i=0, sp=22;
    (function t(){if(i<txt.length){el.textContent+=txt.charAt(i);i++;setTimeout(t,sp)}else{if(cb)cb()}})();
}

// ============ LOAD PARCOURS ============
function load(data, ai){
    if(typeof data==='string'){try{data=JSON.parse(data)}catch(e){return}}
    if(loaded&&ai&&score>0)return;
    parcours=data; step=0; score=0; loaded=true;
    document.getElementById('score-value').textContent='0';
    if(parcours.titre){var t=document.getElementById('route-title');t.textContent='üêæ '+parcours.titre;t.style.display='block'}
    document.getElementById('score-badge').style.display='block';
    if(ai)document.getElementById('ai-badge').style.display='block';
    markers.forEach(function(m){map.removeLayer(m)});markers=[];
    if(polyline)map.removeLayer(polyline);
    var ll=[];
    parcours.etapes.forEach(function(e,i){
        var la=parseFloat(e.latitude),lo=parseFloat(e.longitude);if(isNaN(la)||isNaN(lo))return;
        var p=[la,lo];ll.push(p);
        var m=L.marker(p,{icon:ico(i+1,i===0)}).addTo(map);
        m.bindTooltip(e.lieu_nom,{permanent:false,direction:'top',offset:[0,-20]});
        (function(idx){m.on('click',function(){step=idx;updInfo(idx)})})(i);
        markers.push(m);
    });
    if(!ll.length)return;
    polyline=L.polyline(ll,{color:'#667eea',weight:3,opacity:.6,dashArray:'10,10'}).addTo(map);
    map.fitBounds(L.latLngBounds(ll).pad(.3));
    updInfo(0);
}

function updInfo(i){
    var e=parcours.etapes[i],ty=(e.interaction.type_interaction||'d√©fi').toUpperCase();
    if(ty==='QUIZ')ty='üß© QUIZ';else if(ty==='PHOTO')ty='üì∏ PHOTO';else ty='üëÅÔ∏è OBSERVATION';
    document.getElementById('etape-info-title').textContent='√âtape '+(i+1)+'/'+parcours.etapes.length+' ‚Äî '+e.lieu_nom;
    document.getElementById('etape-info-subtitle').textContent=ty+' ‚Äî Appuyer pour voir ‚Üí';
    document.getElementById('etape-info').style.display='block';
}

function showScr(id){['scr-intro','scr-quiz','scr-photo','scr-result','scr-end'].forEach(function(s){document.getElementById(s).classList.add('hidden');document.getElementById(s).style.display='none'});var el=document.getElementById(id);el.classList.remove('hidden');el.style.display='flex';el.className=el.className.replace(' anim','')+' anim'}

// ============ OPEN √âTAPE ============
function openEtape(){
    var e=parcours.etapes[step];
    showScr('scr-intro');
    document.getElementById('intro-badge').textContent='√âTAPE '+(step+1)+'/'+parcours.etapes.length;
    document.getElementById('intro-lieu').textContent=e.lieu_nom;
    document.getElementById('overlay').style.display='flex';
    document.getElementById('overlay').scrollTop=0;
    speak('intro-bubble', e.narration_arrivee);
    map.flyTo([e.latitude,e.longitude],16,{duration:1});
    markers.forEach(function(m,i){if(i<step)m.setIcon(doneIco());else if(i===step)m.setIcon(ico(i+1,true));else m.setIcon(ico(i+1,false))});
}

function showDefi(){
    var e=parcours.etapes[step],ty=(e.interaction.type_interaction||'observation').toLowerCase();
    if(ty==='quiz')doQuiz(e);else doPhoto(e);
}

function doQuiz(e){
    showScr('scr-quiz');
    document.getElementById('quiz-badge').textContent='üß© QUIZ';
    document.getElementById('quiz-question').textContent=e.interaction.question||e.interaction.consigne||'Question...';
    document.getElementById('quiz-hint').textContent='üí° '+(e.interaction.indice||'Observe bien autour de toi !');
    document.getElementById('quiz-hint').style.display='none';
    var ad=document.getElementById('quiz-answers');ad.innerHTML='';
    var reps=e.interaction.reponses||[],bon=parseInt(e.interaction.bonne_reponse)||0;
    if(!reps.length){var b=document.createElement('button');b.className='btn-primary';b.textContent='‚úÖ J\'ai trouv√© !';b.style.marginTop='20px';b.onclick=function(){result(true,e)};ad.appendChild(b);return}
    reps.forEach(function(r,idx){
        var b=document.createElement('button');b.className='quiz-answer-btn';b.textContent=r;
        b.onclick=function(){
            var all=ad.querySelectorAll('.quiz-answer-btn');all.forEach(function(x){x.style.pointerEvents='none'});
            if(idx===bon){b.classList.add('correct');setTimeout(function(){result(true,e)},800)}
            else{b.classList.add('wrong');all[bon].classList.add('correct');setTimeout(function(){result(false,e)},1200)}
        };ad.appendChild(b);
    });
}

function doPhoto(e){
    showScr('scr-photo');
    var ty=(e.interaction.type_interaction||'observation').toLowerCase();
    document.getElementById('photo-badge').textContent=ty==='photo'?'üì∏ D√âFI PHOTO':'üëÅÔ∏è OBSERVATION';
    document.getElementById('photo-consigne').textContent=e.interaction.consigne||e.interaction.question||'Observe bien cet endroit !';
    speak('photo-bubble', e.interaction.indice||'Prends ton temps et observe bien !');
}
function photoOk(){result(true,parcours.etapes[step])}
function toggleHint(){var h=document.getElementById('quiz-hint');h.style.display=h.style.display==='none'?'block':'none'}

function result(ok,e){
    showScr('scr-result');
    var pts=ok?(e.points||100):0;score+=pts;
    document.getElementById('score-value').textContent=score;
    var badge=document.getElementById('score-badge');badge.classList.remove('score-up');void badge.offsetWidth;badge.classList.add('score-up');
    document.getElementById('res-emoji').textContent=ok?'üéâ':'üòÖ';
    document.getElementById('res-title').textContent=ok?'Bravo !':'Pas cette fois...';
    document.getElementById('res-points').textContent=ok?'+'+pts+' pts':'+0 pts';
    speak('res-bubble', ok?e.narration_reussite:e.narration_echec);
    if(step<markers.length)markers[step].setIcon(doneIco());
    var last=step>=parcours.etapes.length-1;
    document.getElementById('btn-next').textContent=last?'üèÜ R√©sultat final':'√âtape suivante ‚Üí';
}

function nextStep(){
    if(step>=parcours.etapes.length-1){showEnd();return}
    step++;
    document.getElementById('overlay').style.display='none';
    updInfo(step);
    var e=parcours.etapes[step];
    map.flyTo([e.latitude,e.longitude],16,{duration:1.5});
    markers.forEach(function(m,i){if(i<step)m.setIcon(doneIco());else if(i===step)m.setIcon(ico(i+1,true));else m.setIcon(ico(i+1,false))});
}

function showEnd(){
    showScr('scr-end');
    var mx=parcours.etapes.length*100;
    document.getElementById('end-score').textContent=score+' / '+mx+' pts';
    speak('end-bubble', parcours.conclusion||'Bravo aventurier ! Tu as termin√© ce parcours avec brio !');
}
function backToMap(){
    document.getElementById('overlay').style.display='none';
    document.getElementById('etape-info').style.display='none';
    var ll=parcours.etapes.map(function(e){return[e.latitude,e.longitude]});
    map.fitBounds(L.latLngBounds(ll).pad(.3));
}

// ============ START ============
(function(){
    console.log('[Explozill] v5 Moonsky parle');
    var done=false;
    var t=setTimeout(function(){if(!done){done=true;load(DEMO,false)}},45000);
    callWH(function(){done=true;clearTimeout(t)});
})();
</script>
</body>
</html>
