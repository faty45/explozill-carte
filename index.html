<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Explozill - Carte</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pandasuite-bridge/lib/pandasuite-bridge.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* Score flottant */
        #score-badge {
            position: fixed; top: 10px; right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 6px 12px;
            border-radius: 16px; z-index: 1000;
            font-size: 12px; font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }

        /* Titre du parcours */
        #route-title {
            position: fixed; top: 10px; left: 10px; right: 90px;
            background: rgba(255,255,255,0.95);
            padding: 6px 12px;
            border-radius: 10px; z-index: 1000;
            font-size: 12px; font-weight: 600;
            color: #1a1a2e;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Info bulle étape active */
        #etape-info {
            position: fixed; bottom: 15px; left: 15px; right: 15px;
            background: white;
            border-radius: 14px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 999;
            display: none;
            cursor: pointer;
        }
        #etape-info-title {
            font-size: 13px; font-weight: 700;
            color: #1a1a2e; margin-bottom: 3px;
        }
        #etape-info-subtitle {
            font-size: 11px; color: #667eea;
        }
        #etape-info-arrow {
            position: absolute; right: 16px; top: 50%;
            transform: translateY(-50%);
            font-size: 18px; color: #667eea;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="route-title"></div>
<div id="score-badge">Score : <span id="score-value">0</span> pts</div>

<!-- Info bulle en bas : indique l'étape active, clic = envoie à PandaSuite -->
<div id="etape-info" onclick="openEtapeInPandaSuite()">
    <div id="etape-info-title"></div>
    <div id="etape-info-subtitle">APPUYER ICI POUR COMMENCER →</div>
    <div id="etape-info-arrow">›</div>
</div>

<script>
// ============================================================
// EXPLOZILL - CARTE INTERACTIVE
// Version: Démo CCI37 Tours - 10 février 2026
// Mode: Carte GPS + envoi données vers PandaSuite via Bridge
// PAS de loading screen (PandaSuite gère l'écran de chargement)
// PAS de renard (Moonsky est dans PandaSuite)
// ============================================================

// === CONFIGURATION ===
var WEBHOOK_URL = 'https://hook.eu2.make.com/sazwwf4twy6hcfu3qckrqrl4v7hubdbl';

// Paramètres par défaut pour la démo
var DEFAULT_PARAMS = {
    duree: 'Expresso',
    mobilite: 'A pied',
    theme: 'Découverte',
    pauses: 'Non',
    mood: 'Aventurier',
    compo: 'Duo',
    ville: 'Tours',
    lat: '47.3942',
    lng: '0.6885'
};

// === PARCOURS DE DÉMO PRÉ-CHARGÉ (filet de sécurité si webhook échoue) ===
var DEMO_PARCOURS = {
    "titre": "Flash Tour(s) : les pierres parlent vite",
    "ville": "Tours",
    "type_scenario": "Jeu de piste",
    "introduction": "Bienvenue à Tours. Je suis Moonsky, ton renard cyber-futuriste. On va explorer le Vieux Tours ensemble. Garde ton smartphone prêt, on va observer, capturer et décoder le réel.",
    "etapes": [
        {
            "ordre": 1,
            "lieu_nom": "Place Plumereau",
            "latitude": 47.3948,
            "longitude": 0.6833,
            "narration_arrivee": "Te voilà sur la Place Plumereau, cœur vibrant du Vieux Tours. Regarde autour : façades à colombages, terrasses, petits détails qui racontent des siècles. On commence soft, mais précis.",
            "interaction": {
                "type_interaction": "quiz",
                "question": "En levant les yeux autour de la place, combien de maisons à colombages peux-tu repérer ?",
                "reponses": ["8", "12", "15", "20"],
                "bonne_reponse": 1,
                "indice": "Concentre-toi sur les façades avec des poutres en bois visibles."
            },
            "narration_reussite": "Bien vu ! Ton regard d'aventurier capte la géométrie cachée du décor.",
            "narration_echec": "Pas grave. Recalibre ton œil, la suite t'attend.",
            "points": 100
        },
        {
            "ordre": 2,
            "lieu_nom": "Cathédrale Saint-Gatien",
            "latitude": 47.3955,
            "longitude": 0.6944,
            "narration_arrivee": "La Cathédrale Saint-Gatien se dresse devant toi. Plusieurs siècles de construction ont donné ce mélange de styles unique. Observe bien la façade.",
            "interaction": {
                "type_interaction": "quiz",
                "question": "En quelle année a débuté la construction de la cathédrale Saint-Gatien ?",
                "reponses": ["1170", "1236", "1306", "1425"],
                "bonne_reponse": 1,
                "indice": "C'est au XIIIe siècle, sous le règne de Saint Louis."
            },
            "narration_reussite": "Exact ! Tu maîtrises l'histoire comme un vrai pisteur urbain.",
            "narration_echec": "La bonne réponse était 1236. Retiens-la pour la prochaine fois !",
            "points": 100
        },
        {
            "ordre": 3,
            "lieu_nom": "Pont Wilson",
            "latitude": 47.3930,
            "longitude": 0.6880,
            "narration_arrivee": "Le Pont Wilson, surnommé le Pont de Pierre, enjambe la Loire avec élégance. C'est l'un des symboles de Tours. Prends un moment pour admirer la vue.",
            "interaction": {
                "type_interaction": "photo",
                "consigne": "Prends une photo du pont avec la Loire en arrière-plan. Essaie de capturer au moins une arche complète.",
                "indice": "Place-toi sur la rive nord pour avoir le meilleur angle."
            },
            "narration_reussite": "Superbe cliché ! Tu as l'œil du photographe urbain.",
            "narration_echec": "Pas de souci, l'important c'est d'avoir profité de la vue !",
            "points": 100
        }
    ],
    "conclusion": "Parcours terminé ! Tu as exploré le cœur de Tours avec brio. Reviens quand tu veux, j'ai d'autres secrets à te faire chasser."
};

// === VARIABLES GLOBALES ===
var map, markers = [], polyline;
var parcours = null;
var currentStep = 0;
var score = 0;
var parcoursLoaded = false;

// === INITIALISER LA CARTE ===
map = L.map('map', {
    center: [47.3942, 0.6885],
    zoom: 15,
    zoomControl: false
});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
}).addTo(map);

// === RÉCUPÉRER LES PARAMÈTRES ===
function getParams() {
    var params = JSON.parse(JSON.stringify(DEFAULT_PARAMS));
    var urlParams = new URLSearchParams(window.location.search);
    urlParams.forEach(function(value, key) {
        if (value) params[key] = value;
    });
    if (window.location.hash) {
        try {
            var hashParams = new URLSearchParams(window.location.hash.substring(1));
            hashParams.forEach(function(value, key) {
                if (value) params[key] = value;
            });
        } catch(e) {}
    }
    return params;
}

// === APPELER LE WEBHOOK MAKE.COM ===
function callWebhook(onSuccess) {
    var params = getParams();
    var url = WEBHOOK_URL + '?duree=' + encodeURIComponent(params.duree)
        + '&mobilite=' + encodeURIComponent(params.mobilite)
        + '&theme=' + encodeURIComponent(params.theme)
        + '&pauses=' + encodeURIComponent(params.pauses)
        + '&mood=' + encodeURIComponent(params.mood)
        + '&compo=' + encodeURIComponent(params.compo)
        + '&ville=' + encodeURIComponent(params.ville)
        + '&lat=' + encodeURIComponent(params.lat)
        + '&lng=' + encodeURIComponent(params.lng);

    console.log('[Explozill] Appel webhook:', url);

    // Informer PandaSuite que le chargement commence
    try { PandaBridge.send("loading_start", [{ status: "Connexion à l'IA..." }]); } catch(e) {}

    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.timeout = 120000;

    xhr.onload = function() {
        console.log('[Explozill] Webhook réponse status:', xhr.status);
        if (xhr.status === 200 && xhr.responseText && xhr.responseText !== 'Accepted') {
            try {
                var routeData = parseRouteData(xhr.responseText);
                if (routeData && routeData.etapes && routeData.etapes.length > 0) {
                    console.log('[Explozill] Parcours IA reçu:', routeData.titre, '-', routeData.etapes.length, 'étapes');
                    try { PandaBridge.send("loading_status", [{ status: "Parcours prêt !" }]); } catch(e) {}
                    if (onSuccess) onSuccess();
                    loadParcours(routeData, true);
                    return;
                }
            } catch(e) {
                console.log('[Explozill] Erreur parsing webhook:', e);
            }
        }
        console.log('[Explozill] Webhook non exploitable, parcours démo en attente');
    };

    xhr.onerror = function() {
        console.log('[Explozill] Webhook injoignable');
        try { PandaBridge.send("loading_status", [{ status: "Mode démo" }]); } catch(e) {}
    };

    xhr.ontimeout = function() {
        console.log('[Explozill] Webhook timeout');
        try { PandaBridge.send("loading_status", [{ status: "Mode démo" }]); } catch(e) {}
    };

    xhr.send();
}

// === PARSER LA RÉPONSE ===
function parseRouteData(rawData) {
    if (typeof rawData === 'object' && rawData !== null) return normalizeRouteData(rawData);
    if (typeof rawData === 'string') {
        var str = rawData.trim()
            .replace(/```json\s*/g, '').replace(/```\s*/g, '')
            .replace(/\s*du module OpenAI.*$/s, '')
            .replace(/\s*du module ChatGPT.*$/s, '');
        try { return normalizeRouteData(JSON.parse(str)); } catch(e) {}
        var jsonStart = str.indexOf('{');
        var jsonEnd = str.lastIndexOf('}');
        if (jsonStart !== -1 && jsonEnd > jsonStart) {
            try { return normalizeRouteData(JSON.parse(str.substring(jsonStart, jsonEnd + 1))); } catch(e2) {}
        }
    }
    return null;
}

function normalizeRouteData(data) {
    if (data.parcours) data = data.parcours;
    if (data.route) data = data.route;
    if (data.result) {
        if (typeof data.result === 'string') { try { data = JSON.parse(data.result); } catch(e) { return null; } }
        else data = data.result;
    }
    if (!data.etapes && data.waypoints) data.etapes = data.waypoints;
    if (!data.etapes && data.steps) data.etapes = data.steps;
    if (data.etapes && Array.isArray(data.etapes)) {
        data.etapes = data.etapes.map(function(etape, i) {
            return {
                ordre: etape.ordre || (i + 1),
                lieu_nom: etape.lieu_nom || etape.name || etape.lieu || etape.title || ('Étape ' + (i + 1)),
                latitude: parseFloat(etape.latitude || etape.lat),
                longitude: parseFloat(etape.longitude || etape.lng || etape.lon),
                narration_arrivee: etape.narration_arrivee || etape.narration || etape.description || '',
                interaction: normalizeInteraction(etape.interaction || etape),
                narration_reussite: etape.narration_reussite || etape.success_text || 'Bravo !',
                narration_echec: etape.narration_echec || etape.failure_text || 'Pas tout à fait...',
                points: etape.points || 100
            };
        });
    }
    return data;
}

function normalizeInteraction(inter) {
    if (!inter) return { type_interaction: 'defi', consigne: 'Explorez cet endroit !' };
    if (inter.type_interaction) return inter;
    if (inter.question && inter.reponses) {
        return { type_interaction: 'quiz', question: inter.question, reponses: inter.reponses, bonne_reponse: inter.bonne_reponse || 0, indice: inter.indice || '' };
    }
    if (inter.consigne) {
        return { type_interaction: inter.type || 'defi', consigne: inter.consigne, indice: inter.indice || '' };
    }
    return { type_interaction: 'defi', consigne: 'Explorez cet endroit !' };
}

// === ICÔNES PERSONNALISÉES ===
function createStepIcon(num, active) {
    return L.divIcon({
        className: 'custom-marker',
        html: '<div style="width:34px;height:34px;border-radius:50%;background:'
            + (active ? 'linear-gradient(135deg,#667eea,#764ba2)' : '#ccc')
            + ';color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:3px solid white;">'
            + num + '</div>',
        iconSize: [34, 34],
        iconAnchor: [17, 17]
    });
}

function createCompletedIcon(num) {
    return L.divIcon({
        className: 'custom-marker',
        html: '<div style="width:34px;height:34px;border-radius:50%;background:#28a745;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:3px solid white;">✓</div>',
        iconSize: [34, 34],
        iconAnchor: [17, 17]
    });
}

// ============================================================
// === CHARGER LE PARCOURS (carte + envoi à PandaSuite) ===
// ============================================================
function loadParcours(data, fromAI) {
    if (typeof data === 'string') {
        try { data = JSON.parse(data); } catch(e) { return; }
    }

    if (parcoursLoaded && fromAI && score > 0) {
        console.log('[Explozill] Parcours IA ignoré car le joueur a déjà commencé');
        return;
    }

    parcours = data;
    currentStep = 0;
    score = 0;
    parcoursLoaded = true;
    document.getElementById('score-value').textContent = '0';

    // Afficher le titre
    if (parcours.titre) {
        var titleEl = document.getElementById('route-title');
        titleEl.textContent = parcours.titre;
        titleEl.style.display = 'block';
    }

    // Score
    document.getElementById('score-badge').style.display = 'block';

    // Supprimer anciens marqueurs
    markers.forEach(function(m) { map.removeLayer(m); });
    markers = [];
    if (polyline) map.removeLayer(polyline);

    // Créer les marqueurs
    var latlngs = [];
    parcours.etapes.forEach(function(etape, i) {
        var lat = parseFloat(etape.latitude);
        var lng = parseFloat(etape.longitude);
        if (isNaN(lat) || isNaN(lng)) return;

        var ll = [lat, lng];
        latlngs.push(ll);

        var marker = L.marker(ll, {
            icon: createStepIcon(i + 1, i === 0)
        }).addTo(map);

        marker.bindTooltip(etape.lieu_nom, {
            permanent: false,
            direction: 'top',
            offset: [0, -20]
        });

        // Clic sur un marqueur = envoyer l'étape à PandaSuite
        marker.on('click', function() {
            currentStep = i;
            updateEtapeInfo(i);
            sendEtapeToPandaSuite(i);
        });

        markers.push(marker);
    });

    if (latlngs.length === 0) return;

    // Tracer le parcours
    polyline = L.polyline(latlngs, {
        color: '#667eea',
        weight: 3,
        opacity: 0.6,
        dashArray: '10, 10'
    }).addTo(map);

    // Centrer la carte
    map.fitBounds(L.latLngBounds(latlngs).pad(0.3));

    // Afficher l'info de la première étape
    updateEtapeInfo(0);

    // ============================================================
    // ENVOYER LE PARCOURS À PANDASUITE VIA LE BRIDGE
    // On n'envoie PAS etape_active automatiquement ici.
    // L'utilisateur doit cliquer sur la bulle info pour naviguer.
    // ============================================================
    try {
        // Événement 1 : Parcours complet (tout le JSON)
        PandaBridge.send("parcours_ready", [parcours]);
        console.log('[Explozill] → PandaBridge: parcours_ready envoyé');
    } catch(e) {
        console.log('[Explozill] PandaBridge non disponible, mode standalone');
    }

    console.log('[Explozill] Parcours chargé:', parcours.titre, '-', markers.length, 'étapes');
}

// ============================================================
// === ENVOYER UNE ÉTAPE À PANDASUITE ===
// ============================================================
function sendEtapeToPandaSuite(stepIndex) {
    var etape = parcours.etapes[stepIndex];
    var etapeData = {
        ordre: etape.ordre,
        lieu_nom: etape.lieu_nom,
        latitude: etape.latitude,
        longitude: etape.longitude,
        narration_arrivee: etape.narration_arrivee,
        narration_reussite: etape.narration_reussite,
        narration_echec: etape.narration_echec,
        points: etape.points,
        type_interaction: etape.interaction.type_interaction,
        question: etape.interaction.question || etape.interaction.consigne || '',
        consigne: etape.interaction.consigne || etape.interaction.question || '',
        reponses: etape.interaction.reponses || [],
        bonne_reponse: etape.interaction.bonne_reponse || 0,
        indice: etape.interaction.indice || '',
        element_a_trouver: etape.interaction.element_a_trouver || '',
        etape_num: stepIndex + 1,
        total_etapes: parcours.etapes.length,
        score_actuel: score,
        titre_parcours: parcours.titre,
        introduction: parcours.introduction || '',
        is_last: stepIndex === parcours.etapes.length - 1
    };

    try {
        PandaBridge.send("etape_active", [etapeData]);
        console.log('[Explozill] → PandaBridge: etape_active envoyé - Étape', stepIndex + 1, etape.lieu_nom);
    } catch(e) {
        console.log('[Explozill] PandaBridge non disponible');
    }

    // Centrer la carte sur l'étape
    map.flyTo([etape.latitude, etape.longitude], 16, { duration: 1.5 });

    // Mettre à jour les icônes
    markers.forEach(function(m, idx) {
        if (idx < stepIndex) {
            m.setIcon(createCompletedIcon(idx + 1));
        } else if (idx === stepIndex) {
            m.setIcon(createStepIcon(idx + 1, true));
        } else {
            m.setIcon(createStepIcon(idx + 1, false));
        }
    });
}

// === OUVRIR L'ÉTAPE DANS PANDASUITE ===
function openEtapeInPandaSuite() {
    console.log('[Explozill] Clic bulle → envoi etape_active pour étape', currentStep + 1);
    sendEtapeToPandaSuite(currentStep);
}

// === METTRE À JOUR LA BULLE INFO EN BAS ===
function updateEtapeInfo(stepIndex) {
    var etape = parcours.etapes[stepIndex];
    document.getElementById('etape-info-title').textContent = 
        'Étape ' + (stepIndex + 1) + '/' + parcours.etapes.length + ' : ' + etape.lieu_nom;
    document.getElementById('etape-info-subtitle').textContent = 
        etape.interaction.type_interaction.toUpperCase() + ' — Appuyer pour voir le défi →';
    document.getElementById('etape-info').style.display = 'block';
}

// ============================================================
// === ÉCOUTER LES ÉVÉNEMENTS DE PANDASUITE ===
// ============================================================
try {
    // PandaSuite envoie "etape_reponse" quand l'utilisateur a répondu
    PandaBridge.listen("etape_reponse", function(args) {
        var data = args && args[0] ? args[0] : args;
        console.log('[Explozill] ← PandaBridge: etape_reponse reçu', data);
        
        if (data) {
            if (data.points_gagnes) {
                score += parseInt(data.points_gagnes);
                document.getElementById('score-value').textContent = score;
            }

            var stepIdx = (parseInt(data.etape_num) || currentStep + 1) - 1;
            if (stepIdx >= 0 && stepIdx < markers.length) {
                markers[stepIdx].setIcon(createCompletedIcon(stepIdx + 1));
            }

            if (data.next || data.etape_suivante) {
                var nextStep = stepIdx + 1;
                if (nextStep < parcours.etapes.length) {
                    currentStep = nextStep;
                    updateEtapeInfo(nextStep);
                    sendEtapeToPandaSuite(nextStep);
                } else {
                    showConclusionOnMap();
                }
            }
        }
    });

    // PandaSuite peut demander d'aller à une étape spécifique
    PandaBridge.listen("aller_etape", function(args) {
        var data = args && args[0] ? args[0] : args;
        var stepIdx = (parseInt(data.etape_num || data) || 1) - 1;
        if (stepIdx >= 0 && stepIdx < parcours.etapes.length) {
            currentStep = stepIdx;
            updateEtapeInfo(stepIdx);
            sendEtapeToPandaSuite(stepIdx);
        }
    });

    // PandaSuite peut demander le parcours complet
    PandaBridge.listen("demander_parcours", function() {
        if (parcours) {
            PandaBridge.send("parcours_ready", [parcours]);
        }
    });

} catch(e) {
    console.log('[Explozill] PandaBridge non disponible');
}

// === CONCLUSION SUR LA CARTE ===
function showConclusionOnMap() {
    document.getElementById('etape-info').style.display = 'none';
    var maxScore = parcours.etapes.length * 100;

    try {
        PandaBridge.send("parcours_termine", [{
            score: score,
            total: maxScore,
            titre: parcours.titre,
            conclusion: parcours.conclusion || 'Bravo, aventurier !'
        }]);
        console.log('[Explozill] → PandaBridge: parcours_termine envoyé');
    } catch(e) {}

    var latlngs = parcours.etapes.map(function(e) { return [e.latitude, e.longitude]; });
    map.fitBounds(L.latLngBounds(latlngs).pad(0.3));
}

// === DÉMARRAGE ===
(function() {
    console.log('[Explozill] Démarrage carte...');
    
    // Timeout de sécurité : si le webhook ne répond pas après 45s, parcours démo
    var webhookReceived = false;
    var fallbackTimer = setTimeout(function() {
        if (!webhookReceived) {
            console.log('[Explozill] Timeout webhook, chargement parcours démo');
            try { PandaBridge.send("loading_status", [{ status: "Mode démo" }]); } catch(e) {}
            loadParcours(DEMO_PARCOURS, false);
        }
    }, 45000);
    
    // Appeler le webhook Make.com
    callWebhook(function onSuccess() {
        webhookReceived = true;
        clearTimeout(fallbackTimer);
    });
})();
</script>

</body>
</html>
