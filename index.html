<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Explozill - Carte Parcours</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pandasuite-bridge/lib/pandasuite-bridge.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* Écran de chargement Moonsky */
        #loading-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 3000;
            background: #1a1a2e; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: #fff;
            transition: opacity 0.8s ease;
        }
        #loading-screen.hide { opacity: 0; pointer-events: none; }
        .moonsky-img { width: 150px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310419663030501819/pwPvPthSItnrIyBy.png" class="moonsky-img">
        <p id="status-text">Moonsky prépare ton parcours...</p>
    </div>

    <div id="map"></div>

    <script>
        var map, markers = [];

        // 1. Initialisation de la carte Leaflet
        map = L.map('map', { zoomControl: false }).setView([47.3942, 0.6885], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // 2. Connexion avec PandaSuite
        PandaBridge.init(function() {
            
            // Écoute l'action "Charger le parcours" envoyée par l'Analyseur
            PandaBridge.listen('loadParcours', function(data) {
                if (data && data.parcours_json) {
                    try {
                        // On transforme le texte reçu en objet utilisable
                        var parcours = JSON.parse(data.parcours_json);
                        afficherParcours(parcours);
                    } catch (e) {
                        console.error("Erreur de lecture du JSON", e);
                    }
                }
            });
        });

        function afficherParcours(data) {
            // Nettoyage des anciens points
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            var points = [];

            // Pour chaque étape du JSON, on crée un marqueur
            data.etapes.forEach(function(etape) {
                var latlng = [etape.latitude, etape.longitude];
                points.push(latlng);

                var m = L.marker(latlng).addTo(map)
                         .bindPopup("<b>" + etape.lieu_nom + "</b>");
                markers.push(m);
            });

            // On ajuste la vue de la carte pour voir tous les points
            if (points.length > 0) {
                map.fitBounds(L.latLngBounds(points).pad(0.2));
            }

            // On cache l'écran de chargement
            document.getElementById('loading-screen').classList.add('hide');
        }
    </script>
</body>
</html>
