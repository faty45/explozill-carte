<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Explozill - Carte</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pandasuite-bridge/lib/pandasuite-bridge.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* Ã‰cran de chargement */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transition: opacity 0.8s ease;
        }
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-fox {
            font-size: 60px;
            margin-bottom: 20px;
            animation: bounce 1s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-15px); }
        }
        .loading-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .loading-subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 30px;
            text-align: center;
            padding: 0 40px;
        }
        .loading-bar-container {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .loading-bar {
            height: 100%;
            width: 30%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            animation: loading 1.5s infinite ease-in-out;
        }
        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }
        .loading-status {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }

        /* Panneau d'Ã©tape */
        #panel {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 55%;
            overflow-y: auto;
            padding: 20px;
            transition: transform 0.3s ease;
        }
        #panel.visible { display: block; }
        #panel-handle {
            width: 40px; height: 4px;
            background: #ccc; border-radius: 2px;
            margin: 0 auto 15px;
        }
        #panel-titre {
            font-size: 16px; font-weight: 700;
            color: #1a1a2e; margin-bottom: 8px;
        }
        #panel-narration {
            font-size: 13px; color: #555;
            line-height: 1.5; margin-bottom: 15px;
            font-style: italic;
        }
        #panel-interaction {
            background: #f0f4ff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        #panel-interaction-type {
            font-size: 11px; font-weight: 600;
            color: #667eea; text-transform: uppercase;
            margin-bottom: 8px;
        }
        #panel-interaction-content {
            font-size: 14px; color: #333;
            line-height: 1.5;
        }
        .quiz-btn {
            display: block; width: 100%;
            padding: 12px; margin: 6px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            font-size: 14px; color: #333;
            text-align: left;
            cursor: pointer;
        }
        .quiz-btn:active { background: #f0f4ff; border-color: #667eea; }
        .quiz-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
        .quiz-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }

        #btn-valider {
            display: none;
            width: 100%; padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none;
            border-radius: 12px;
            font-size: 15px; font-weight: 600;
            cursor: pointer;
        }
        #panel-points {
            text-align: center;
            font-size: 13px; color: #667eea;
            font-weight: 600; margin-top: 10px;
        }
        #panel-close {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none;
            font-size: 20px; color: #999; cursor: pointer;
        }

        /* Score flottant */
        #score-badge {
            position: fixed; top: 15px; right: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 8px 15px;
            border-radius: 20px; z-index: 1000;
            font-size: 13px; font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }

        /* Titre du parcours */
        #route-title {
            position: fixed; top: 15px; left: 15px; right: 100px;
            background: rgba(255,255,255,0.95);
            padding: 8px 15px;
            border-radius: 12px; z-index: 1000;
            font-size: 13px; font-weight: 600;
            color: #1a1a2e;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Badge IA */
        #ai-badge {
            position: fixed; top: 55px; left: 15px;
            background: rgba(102,126,234,0.9);
            color: white;
            padding: 4px 10px;
            border-radius: 8px; z-index: 1000;
            font-size: 10px; font-weight: 600;
            display: none;
            letter-spacing: 0.5px;
        }

        /* Bouton Ã©tape suivante */
        #btn-next {
            display: none;
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none;
            border-radius: 12px;
            font-size: 15px; font-weight: 600;
            cursor: pointer; z-index: 999;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        /* Message de fin */
        #conclusion-panel {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        #conclusion-panel.visible { display: flex; }
        #conclusion-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px;
            text-align: center;
            max-width: 350px;
        }
        #conclusion-content h2 {
            font-size: 20px; color: #1a1a2e;
            margin-bottom: 10px;
        }
        #conclusion-content p {
            font-size: 14px; color: #555;
            line-height: 1.6; margin-bottom: 20px;
        }
        #conclusion-score {
            font-size: 28px; font-weight: 700;
            color: #667eea; margin-bottom: 15px;
        }
    </style>
</head>
<body>

<!-- Ã‰cran de chargement -->
<div id="loading-screen">
    <div class="loading-fox">ðŸ¦Š</div>
    <div class="loading-title">Explozill</div>
    <div class="loading-subtitle" id="loading-msg">Notre IA prÃ©pare votre parcours personnalisÃ©...</div>
    <div class="loading-bar-container">
        <div class="loading-bar"></div>
    </div>
    <div class="loading-status" id="loading-status">GÃ©nÃ©ration en cours...</div>
</div>

<div id="map"></div>
<div id="route-title"></div>
<div id="ai-badge">âœ¨ GÃ‰NÃ‰RÃ‰ PAR IA</div>
<div id="score-badge">ðŸ¦Š Score : <span id="score-value">0</span> pts</div>

<div id="panel">
    <button id="panel-close">&times;</button>
    <div id="panel-handle"></div>
    <div id="panel-titre"></div>
    <div id="panel-narration"></div>
    <div id="panel-interaction">
        <div id="panel-interaction-type"></div>
        <div id="panel-interaction-content"></div>
    </div>
    <button id="btn-valider">Valider</button>
    <div id="panel-points"></div>
</div>

<button id="btn-next">Ã‰tape suivante â†’</button>

<div id="conclusion-panel">
    <div id="conclusion-content">
        <h2>ðŸ¦Š Parcours terminÃ© !</h2>
        <div id="conclusion-score"></div>
        <p id="conclusion-text"></p>
    </div>
</div>

<script>
// ============================================================
// EXPLOZILL - CARTE INTERACTIVE
// Version: DÃ©mo CCI37 Tours - 10 fÃ©vrier 2026
// Mode: Parcours dÃ©mo prÃ©-chargÃ© + appel webhook en parallÃ¨le
// ============================================================

// === CONFIGURATION ===
var WEBHOOK_URL = 'https://hook.eu2.make.com/sazwwf4twy6hcfu3qckrqrl4v7hubdbl';

// ParamÃ¨tres par dÃ©faut pour la dÃ©mo
var DEFAULT_PARAMS = {
    duree: 'Expresso',
    mobilite: 'A pied',
    theme: 'DÃ©couverte',
    pauses: 'Non',
    mood: 'Aventurier',
    compo: 'Duo',
    ville: 'Tours',
    lat: '47.3942',
    lng: '0.6885'
};

// === PARCOURS DE DÃ‰MO PRÃ‰-CHARGÃ‰ ===
// GÃ©nÃ©rÃ© par OpenAI via Make.com le 07/02/2026
var DEMO_PARCOURS = {
    "titre": "Flash Tour(s) : les pierres parlent vite",
    "conclusion": "Bravo, explorateur Ã©clair ! En quelques minutes, vous avez traversÃ© des siÃ¨cles d'histoire tourangelle. De la place Plumereau Ã  la cathÃ©drale Saint-Gatien, les pierres vous ont murmurÃ© leurs secrets. Revenez bientÃ´t pour un parcours plus long !",
    "etapes": [
        {
            "ordre": 1,
            "lieu_nom": "Place Plumereau",
            "latitude": 47.3948,
            "longitude": 0.6833,
            "narration_arrivee": "Bienvenue sur la place Plumereau, le cÅ“ur battant du Vieux Tours ! Autour de vous, des maisons Ã  colombages des XVe et XVIe siÃ¨cles racontent l'histoire mÃ©diÃ©vale de la ville. Jadis place du marchÃ©, elle est aujourd'hui le lieu de rendez-vous prÃ©fÃ©rÃ© des Tourangeaux.",
            "interaction": {
                "type_interaction": "quiz",
                "question": "Combien de maisons Ã  colombages classÃ©es entourent la place Plumereau ?",
                "reponses": ["5", "8", "12", "15"],
                "bonne_reponse": 2,
                "indice": "Regardez bien autour de vous, comptez les faÃ§ades Ã  pans de bois..."
            },
            "narration_reussite": "Excellent ! On compte environ 12 maisons Ã  colombages classÃ©es autour de cette place emblÃ©matique.",
            "narration_echec": "Pas tout Ã  fait ! On dÃ©nombre environ 12 maisons Ã  colombages classÃ©es sur cette place historique.",
            "points": 100
        },
        {
            "ordre": 2,
            "lieu_nom": "CathÃ©drale Saint-Gatien",
            "latitude": 47.3966,
            "longitude": 0.6956,
            "narration_arrivee": "Vous voici devant la majestueuse cathÃ©drale Saint-Gatien ! Sa construction a dÃ©butÃ© au XIIIe siÃ¨cle et s'est Ã©talÃ©e sur prÃ¨s de 400 ans, ce qui explique le mÃ©lange de styles architecturaux, du gothique primitif au gothique flamboyant. Ses deux tours culminent Ã  plus de 60 mÃ¨tres.",
            "interaction": {
                "type_interaction": "quiz",
                "question": "En quelle annÃ©e a dÃ©butÃ© la construction de la cathÃ©drale Saint-Gatien ?",
                "reponses": ["1170", "1236", "1305", "1412"],
                "bonne_reponse": 1,
                "indice": "C'est au XIIIe siÃ¨cle, sous le rÃ¨gne de Saint Louis..."
            },
            "narration_reussite": "Bravo ! La construction a bien dÃ©butÃ© en 1236, sous l'impulsion de l'archevÃªque de Tours.",
            "narration_echec": "C'Ã©tait 1236 ! La cathÃ©drale a mis prÃ¨s de 4 siÃ¨cles Ã  Ãªtre achevÃ©e, d'oÃ¹ son mÃ©lange de styles.",
            "points": 100
        }
    ]
};

// === VARIABLES GLOBALES ===
var map, parcours, markers = [], polyline;
var currentStep = 0;
var score = 0;
var stepCompleted = false;
var parcoursLoaded = false;

// === INITIALISER LA CARTE ===
map = L.map('map', {
    zoomControl: false,
    attributionControl: false
}).setView([47.3942, 0.6885], 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

// === LIRE LES PARAMÃˆTRES URL ===
function getParams() {
    var params = {};
    Object.keys(DEFAULT_PARAMS).forEach(function(key) {
        params[key] = DEFAULT_PARAMS[key];
    });
    var urlParams = new URLSearchParams(window.location.search);
    urlParams.forEach(function(value, key) {
        if (value) params[key] = value;
    });
    if (window.location.hash) {
        try {
            var hashParams = new URLSearchParams(window.location.hash.substring(1));
            hashParams.forEach(function(value, key) {
                if (value) params[key] = value;
            });
        } catch(e) {}
    }
    return params;
}

// === APPELER LE WEBHOOK MAKE.COM ===
function callWebhook(onSuccess) {
    var params = getParams();
    var url = WEBHOOK_URL + '?duree=' + encodeURIComponent(params.duree)
        + '&mobilite=' + encodeURIComponent(params.mobilite)
        + '&theme=' + encodeURIComponent(params.theme)
        + '&pauses=' + encodeURIComponent(params.pauses)
        + '&mood=' + encodeURIComponent(params.mood)
        + '&compo=' + encodeURIComponent(params.compo)
        + '&ville=' + encodeURIComponent(params.ville)
        + '&lat=' + encodeURIComponent(params.lat)
        + '&lng=' + encodeURIComponent(params.lng);

    console.log('[Explozill] Appel webhook:', url);

    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.timeout = 120000;

    xhr.onload = function() {
        console.log('[Explozill] Webhook rÃ©ponse status:', xhr.status);
        console.log('[Explozill] RÃ©ponse brute:', xhr.responseText.substring(0, 200));
        if (xhr.status === 200 && xhr.responseText && xhr.responseText !== 'Accepted') {
            try {
                var routeData = parseRouteData(xhr.responseText);
                if (routeData && routeData.etapes && routeData.etapes.length > 0) {
                    console.log('[Explozill] Parcours IA reÃ§u:', routeData.titre, '-', routeData.etapes.length, 'Ã©tapes');
                    updateLoadingStatus('Parcours prÃªt !');
                    if (onSuccess) onSuccess();
                    setTimeout(function() {
                        loadParcours(routeData, true);
                        hideLoading();
                    }, 500);
                    return;
                }
            } catch(e) {
                console.log('[Explozill] Erreur parsing webhook:', e);
            }
        }
        console.log('[Explozill] Webhook non exploitable, parcours dÃ©mo en attente');
    };

    xhr.onerror = function() {
        console.log('[Explozill] Webhook injoignable, parcours dÃ©mo conservÃ©');
    };

    xhr.ontimeout = function() {
        console.log('[Explozill] Webhook timeout, parcours dÃ©mo conservÃ©');
    };

    xhr.send();
}

// === PARSER LA RÃ‰PONSE ===
function parseRouteData(rawData) {
    if (typeof rawData === 'object' && rawData !== null) return normalizeRouteData(rawData);
    if (typeof rawData === 'string') {
        // Nettoyer le texte parasite de Make.com
        var str = rawData.trim()
            .replace(/```json\s*/g, '').replace(/```\s*/g, '')
            .replace(/\s*du module OpenAI.*$/s, '')
            .replace(/\s*du module ChatGPT.*$/s, '');
        try { return normalizeRouteData(JSON.parse(str)); } catch(e) {
            console.log('[Explozill] Parse direct Ã©chouÃ©, tentative extraction JSON...');
        }
        // Extraire le JSON entre le premier { et le dernier }
        var jsonStart = str.indexOf('{');
        var jsonEnd = str.lastIndexOf('}');
        if (jsonStart !== -1 && jsonEnd > jsonStart) {
            try { return normalizeRouteData(JSON.parse(str.substring(jsonStart, jsonEnd + 1))); } catch(e2) {
                console.log('[Explozill] Extraction JSON Ã©chouÃ©e aussi');
            }
        }
    }
    return null;
}

function normalizeRouteData(data) {
    if (data.parcours) data = data.parcours;
    if (data.route) data = data.route;
    if (data.result) {
        if (typeof data.result === 'string') { try { data = JSON.parse(data.result); } catch(e) { return null; } }
        else data = data.result;
    }
    if (!data.etapes && data.waypoints) data.etapes = data.waypoints;
    if (!data.etapes && data.steps) data.etapes = data.steps;
    if (data.etapes && Array.isArray(data.etapes)) {
        data.etapes = data.etapes.map(function(etape, i) {
            return {
                ordre: etape.ordre || (i + 1),
                lieu_nom: etape.lieu_nom || etape.name || etape.lieu || etape.title || ('Ã‰tape ' + (i + 1)),
                latitude: parseFloat(etape.latitude || etape.lat),
                longitude: parseFloat(etape.longitude || etape.lng || etape.lon),
                narration_arrivee: etape.narration_arrivee || etape.narration || etape.description || '',
                interaction: normalizeInteraction(etape.interaction || etape),
                narration_reussite: etape.narration_reussite || etape.success_text || 'Bravo !',
                narration_echec: etape.narration_echec || etape.failure_text || 'Pas tout Ã  fait...',
                points: etape.points || 100
            };
        });
    }
    return data;
}

function normalizeInteraction(inter) {
    if (!inter) return { type_interaction: 'defi', consigne: 'Explorez cet endroit !' };
    if (inter.type_interaction) return inter;
    if (inter.question && inter.reponses) {
        return { type_interaction: 'quiz', question: inter.question, reponses: inter.reponses, bonne_reponse: inter.bonne_reponse || 0, indice: inter.indice || '' };
    }
    if (inter.consigne) {
        return { type_interaction: inter.type || 'defi', consigne: inter.consigne, indice: inter.indice || '' };
    }
    return { type_interaction: 'defi', consigne: 'Explorez cet endroit !' };
}

// === UI LOADING ===
function updateLoadingStatus(msg) {
    document.getElementById('loading-status').textContent = msg;
}

function hideLoading() {
    var screen = document.getElementById('loading-screen');
    screen.classList.add('hidden');
    setTimeout(function() { screen.style.display = 'none'; }, 800);
}

// === ICÃ”NES PERSONNALISÃ‰ES ===
function createStepIcon(num, active) {
    return L.divIcon({
        className: 'custom-marker',
        html: '<div style="width:36px;height:36px;border-radius:50%;background:'
            + (active ? 'linear-gradient(135deg,#667eea,#764ba2)' : '#ccc')
            + ';color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:3px solid white;">'
            + num + '</div>',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
    });
}

function createCompletedIcon(num) {
    return L.divIcon({
        className: 'custom-marker',
        html: '<div style="width:36px;height:36px;border-radius:50%;background:#28a745;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:3px solid white;">âœ“</div>',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
    });
}

// === CHARGER LE PARCOURS ===
function loadParcours(data, fromAI) {
    if (typeof data === 'string') {
        try { data = JSON.parse(data); } catch(e) { return; }
    }

    // Si un parcours est dÃ©jÃ  en cours et qu'on reÃ§oit le vrai parcours IA,
    // on le remplace seulement si l'utilisateur n'a pas encore commencÃ© Ã  jouer
    if (parcoursLoaded && fromAI && score > 0) {
        console.log('[Explozill] Parcours IA ignorÃ© car le joueur a dÃ©jÃ  commencÃ©');
        return;
    }

    parcours = data;
    currentStep = 0;
    score = 0;
    parcoursLoaded = true;
    document.getElementById('score-value').textContent = '0';

    // Afficher le titre
    if (parcours.titre) {
        var titleEl = document.getElementById('route-title');
        titleEl.textContent = 'ðŸ¦Š ' + parcours.titre;
        titleEl.style.display = 'block';
    }

    // Badge IA
    var aiBadge = document.getElementById('ai-badge');
    aiBadge.textContent = fromAI ? 'âœ¨ GÃ‰NÃ‰RÃ‰ PAR IA EN DIRECT' : 'âœ¨ GÃ‰NÃ‰RÃ‰ PAR IA';
    aiBadge.style.display = 'block';

    // Score
    document.getElementById('score-badge').style.display = 'block';

    // Supprimer anciens marqueurs
    markers.forEach(function(m) { map.removeLayer(m); });
    markers = [];
    if (polyline) map.removeLayer(polyline);

    // CrÃ©er les marqueurs
    var latlngs = [];
    parcours.etapes.forEach(function(etape, i) {
        var lat = parseFloat(etape.latitude);
        var lng = parseFloat(etape.longitude);
        if (isNaN(lat) || isNaN(lng)) return;

        var ll = [lat, lng];
        latlngs.push(ll);

        var marker = L.marker(ll, {
            icon: createStepIcon(i + 1, i === 0)
        }).addTo(map);

        marker.bindTooltip(etape.lieu_nom, {
            permanent: false,
            direction: 'top',
            offset: [0, -20]
        });

        marker.on('click', function() {
            if (i === currentStep) showPanel(i);
        });

        markers.push(marker);
    });

    if (latlngs.length === 0) return;

    // Tracer le parcours
    polyline = L.polyline(latlngs, {
        color: '#667eea',
        weight: 3,
        opacity: 0.6,
        dashArray: '10, 10'
    }).addTo(map);

    // Centrer la carte
    map.fitBounds(L.latLngBounds(latlngs).pad(0.3));

    // Bouton premiÃ¨re Ã©tape
    showNextButton();

    // Notifier PandaSuite
    try {
        PandaBridge.send("parcours_charge", [{
            titre: parcours.titre,
            nb_etapes: parcours.etapes.length
        }]);
    } catch(e) {}

    console.log('[Explozill] Parcours chargÃ©:', parcours.titre, '-', markers.length, 'Ã©tapes');
}

// === AFFICHER LE PANNEAU D'Ã‰TAPE ===
function showPanel(stepIndex) {
    var etape = parcours.etapes[stepIndex];
    var panel = document.getElementById('panel');

    document.getElementById('panel-titre').textContent = etape.ordre + '. ' + etape.lieu_nom;
    document.getElementById('panel-narration').textContent = etape.narration_arrivee;

    var typeDiv = document.getElementById('panel-interaction-type');
    var contentDiv = document.getElementById('panel-interaction-content');
    var btnValider = document.getElementById('btn-valider');

    stepCompleted = false;
    btnValider.style.display = 'none';
    document.getElementById('panel-points').textContent = '';

    var interaction = etape.interaction;
    typeDiv.textContent = (interaction.type_interaction || 'dÃ©fi').toUpperCase();

    switch(interaction.type_interaction) {
        case 'quiz':
            var html = '<p style="margin-bottom:12px;font-weight:600;">' + interaction.question + '</p>';
            if (interaction.reponses && Array.isArray(interaction.reponses)) {
                interaction.reponses.forEach(function(rep, i) {
                    html += '<button class="quiz-btn" data-index="' + i + '" data-correct="' + interaction.bonne_reponse + '">' + rep + '</button>';
                });
            }
            if (interaction.indice) {
                html += '<p style="margin-top:10px;font-size:11px;color:#999;">ðŸ’¡ Indice : ' + interaction.indice + '</p>';
            }
            contentDiv.innerHTML = html;

            contentDiv.querySelectorAll('.quiz-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    if (stepCompleted) return;
                    var idx = parseInt(this.getAttribute('data-index'));
                    var correct = parseInt(this.getAttribute('data-correct'));
                    stepCompleted = true;
                    if (idx === correct) {
                        this.classList.add('correct');
                        score += etape.points;
                        document.getElementById('score-value').textContent = score;
                        document.getElementById('panel-points').textContent = 'ðŸŽ‰ +' + etape.points + ' pts ! ' + (etape.narration_reussite || '');
                    } else {
                        this.classList.add('wrong');
                        var correctBtn = contentDiv.querySelectorAll('.quiz-btn')[correct];
                        if (correctBtn) correctBtn.classList.add('correct');
                        document.getElementById('panel-points').textContent = etape.narration_echec || 'Pas tout Ã  fait...';
                    }
                    completeStep(stepIndex);
                });
            });
            break;

        case 'photo':
            contentDiv.innerHTML = '<p style="font-weight:600;">' + (interaction.consigne || 'Prenez une photo !') + '</p>'
                + (interaction.indice ? '<p style="margin-top:10px;font-size:11px;color:#999;">ðŸ’¡ ' + interaction.indice + '</p>' : '');
            btnValider.style.display = 'block';
            btnValider.textContent = 'ðŸ“¸ Photo prise !';
            btnValider.onclick = function() {
                if (stepCompleted) return;
                stepCompleted = true;
                score += etape.points;
                document.getElementById('score-value').textContent = score;
                document.getElementById('panel-points').textContent = 'ðŸŽ‰ +' + etape.points + ' pts ! ' + (etape.narration_reussite || '');
                completeStep(stepIndex);
            };
            break;

        case 'observation':
            contentDiv.innerHTML = '<p style="font-weight:600;">' + (interaction.consigne || 'Observez bien !') + '</p>'
                + '<input type="number" id="obs-input" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;margin-top:10px;" placeholder="Votre rÃ©ponse...">'
                + (interaction.indice ? '<p style="margin-top:10px;font-size:11px;color:#999;">ðŸ’¡ ' + interaction.indice + '</p>' : '');
            btnValider.style.display = 'block';
            btnValider.textContent = 'Valider ma rÃ©ponse';
            btnValider.onclick = function() {
                if (stepCompleted) return;
                var val = parseInt(document.getElementById('obs-input').value);
                var correct = interaction.bonne_reponse;
                var marge = interaction.marge_erreur || 0;
                stepCompleted = true;
                if (Math.abs(val - correct) <= marge) {
                    score += etape.points;
                    document.getElementById('score-value').textContent = score;
                    document.getElementById('panel-points').textContent = 'ðŸŽ‰ +' + etape.points + ' pts ! ' + (etape.narration_reussite || '');
                } else {
                    document.getElementById('panel-points').textContent = etape.narration_echec || 'Pas tout Ã  fait...';
                }
                completeStep(stepIndex);
            };
            break;

        case 'code':
            contentDiv.innerHTML = '<p style="font-weight:600;">' + (interaction.consigne || 'Trouvez le code !') + '</p>'
                + '<input type="text" id="code-input" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:16px;margin-top:10px;" placeholder="Entrez le code...">'
                + (interaction.indice ? '<p style="margin-top:10px;font-size:11px;color:#999;">ðŸ’¡ ' + interaction.indice + '</p>' : '');
            btnValider.style.display = 'block';
            btnValider.textContent = 'Valider le code';
            btnValider.onclick = function() {
                if (stepCompleted) return;
                var val = document.getElementById('code-input').value.trim().toUpperCase();
                var correct = String(interaction.bonne_reponse).toUpperCase().replace(/-/g, '');
                stepCompleted = true;
                if (val.replace(/-/g, '') === correct) {
                    score += etape.points;
                    document.getElementById('score-value').textContent = score;
                    document.getElementById('panel-points').textContent = 'ðŸŽ‰ +' + etape.points + ' pts ! ' + (etape.narration_reussite || '');
                } else {
                    document.getElementById('panel-points').textContent = etape.narration_echec || 'Pas tout Ã  fait...';
                }
                completeStep(stepIndex);
            };
            break;

        default:
            contentDiv.innerHTML = '<p style="font-weight:600;">' + (interaction.consigne || interaction.question || 'RÃ©alisez le dÃ©fi !') + '</p>'
                + (interaction.indice ? '<p style="margin-top:10px;font-size:11px;color:#999;">ðŸ’¡ ' + interaction.indice + '</p>' : '');
            btnValider.style.display = 'block';
            btnValider.textContent = 'DÃ©fi rÃ©alisÃ© âœ“';
            btnValider.onclick = function() {
                if (stepCompleted) return;
                stepCompleted = true;
                score += etape.points;
                document.getElementById('score-value').textContent = score;
                document.getElementById('panel-points').textContent = 'ðŸŽ‰ +' + etape.points + ' pts ! ' + (etape.narration_reussite || '');
                completeStep(stepIndex);
            };
    }

    panel.classList.add('visible');
    document.getElementById('btn-next').style.display = 'none';
}

// === COMPLÃ‰TER UNE Ã‰TAPE ===
function completeStep(stepIndex) {
    markers[stepIndex].setIcon(createCompletedIcon(stepIndex + 1));
    try {
        PandaBridge.send("etape_complete", [{
            etape: stepIndex + 1,
            lieu: parcours.etapes[stepIndex].lieu_nom,
            score: score,
            total_etapes: parcours.etapes.length
        }]);
    } catch(e) {}

    setTimeout(function() {
        if (stepIndex < parcours.etapes.length - 1) {
            currentStep = stepIndex + 1;
            markers[currentStep].setIcon(createStepIcon(currentStep + 1, true));
            showNextButton();
        } else {
            showConclusion();
        }
    }, 2000);
}

// === BOUTON Ã‰TAPE SUIVANTE ===
function showNextButton() {
    var btn = document.getElementById('btn-next');
    btn.textContent = 'Aller Ã  l\'Ã©tape ' + (currentStep + 1) + ' â†’';
    btn.style.display = 'block';
    btn.onclick = function() {
        document.getElementById('panel').classList.remove('visible');
        var etape = parcours.etapes[currentStep];
        map.flyTo([etape.latitude, etape.longitude], 16, { duration: 1.5 });
        setTimeout(function() { showPanel(currentStep); }, 1600);
    };
}

// === CONCLUSION ===
function showConclusion() {
    document.getElementById('panel').classList.remove('visible');
    document.getElementById('btn-next').style.display = 'none';
    var maxScore = parcours.etapes.length * 100;
    document.getElementById('conclusion-score').textContent = score + ' / ' + maxScore + ' pts';
    document.getElementById('conclusion-text').textContent = parcours.conclusion || 'Bravo, aventurier !';
    document.getElementById('conclusion-panel').classList.add('visible');
    try {
        PandaBridge.send("parcours_termine", [{
            score: score,
            total: maxScore,
            titre: parcours.titre
        }]);
    } catch(e) {}
}

// === FERMER LE PANNEAU ===
document.getElementById('panel-close').addEventListener('click', function() {
    document.getElementById('panel').classList.remove('visible');
    showNextButton();
});

// === RÃ‰CEPTION DEPUIS PANDASUITE ===
try {
    PandaBridge.listen("marker18646", function(args) {
        if (args && args[0]) { hideLoading(); loadParcours(args[0], true); return; }
        PandaBridge.getProperties(function(props) {
            if (props && props.parcours_genere) { hideLoading(); loadParcours(props.parcours_genere, true); }
        });
    });
    PandaBridge.listen('props', function(props) {
        if (props && props.parcours_genere) { hideLoading(); loadParcours(props.parcours_genere, true); }
    });
} catch(e) {
    console.log('[Explozill] PandaBridge non disponible');
}

// === DÃ‰MARRAGE ===
var webhookReceived = false;

(function() {
    console.log('[Explozill] DÃ©marrage...');
    
    // Ã‰tape 1 : Afficher l'Ã©cran de chargement
    updateLoadingStatus('Connexion Ã  l\'IA...');
    
    // Messages de progression pendant l'attente
    var loadingMessages = [
        { time: 3000, msg: 'Recherche des lieux...' },
        { time: 8000, msg: 'GÃ©nÃ©ration du parcours...' },
        { time: 15000, msg: 'CrÃ©ation des dÃ©fis...' },
        { time: 25000, msg: 'Finalisation...' }
    ];
    var loadingTimers = loadingMessages.map(function(m) {
        return setTimeout(function() {
            if (!webhookReceived) updateLoadingStatus(m.msg);
        }, m.time);
    });
    
    // Timeout de sÃ©curitÃ© : si le webhook ne rÃ©pond pas aprÃ¨s 45s,
    // charger le parcours dÃ©mo
    var fallbackTimer = setTimeout(function() {
        if (!webhookReceived) {
            console.log('[Explozill] Timeout webhook, chargement parcours dÃ©mo');
            updateLoadingStatus('Parcours prÃªt !');
            setTimeout(function() {
                loadParcours(DEMO_PARCOURS, false);
                hideLoading();
            }, 500);
        }
    }, 45000);
    
    // Appeler le webhook Make.com
    callWebhook(function onSuccess() {
        // Annuler les timers de fallback
        webhookReceived = true;
        loadingTimers.forEach(function(t) { clearTimeout(t); });
        clearTimeout(fallbackTimer);
    });
})();
</script>

</body>
</html>
