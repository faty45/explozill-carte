<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Explozill - Carte</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{width:100%;height:100%;overflow:hidden;font-family:'Nunito',-apple-system,sans-serif}
        #map{width:100%;height:100%;z-index:1}

        /* ===== LOADING SCREEN ===== */
        #loading-screen{
            position:fixed;top:0;left:0;right:0;bottom:0;z-index:3000;
            background:linear-gradient(160deg,#0a1628 0%,#1a237e 40%,#283593 70%,#0d47a1 100%);
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            padding:32px 24px;text-align:center;color:#fff;
            transition:opacity .6s ease
        }
        #loading-screen.hide{opacity:0;pointer-events:none}
        .ld-moonsky{width:120px;height:120px;object-fit:contain;filter:drop-shadow(0 4px 16px rgba(0,0,0,.5));animation:moonBounce 1.5s ease-in-out infinite}
        @keyframes moonBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-18px)}}
        .ld-title{font-size:22px;font-weight:900;margin-top:22px;margin-bottom:6px}
        .ld-city{font-size:15px;font-weight:700;opacity:.6;margin-bottom:28px}
        .ld-bubble{background:rgba(255,255,255,.12);backdrop-filter:blur(12px);border:1.5px solid rgba(255,255,255,.2);border-radius:18px;padding:16px 22px;font-size:17px;font-weight:700;line-height:1.65;color:#fff;max-width:330px;min-height:65px;margin-bottom:24px}
        .ld-dots{display:flex;gap:10px;justify-content:center}
        .ld-dots span{width:11px;height:11px;border-radius:50%;background:rgba(255,255,255,.35);animation:dotPulse 1.4s ease-in-out infinite}
        .ld-dots span:nth-child(2){animation-delay:.2s}
        .ld-dots span:nth-child(3){animation-delay:.4s}
        @keyframes dotPulse{0%,80%,100%{transform:scale(.5);opacity:.35}40%{transform:scale(1.1);opacity:1}}

        /* ===== UI BADGES ===== */
        #score-badge{position:fixed;top:12px;right:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:8px 16px;border-radius:20px;z-index:1000;font-size:15px;font-weight:800;box-shadow:0 3px 14px rgba(0,0,0,.25);display:none}
        #route-title{position:fixed;top:12px;left:12px;right:110px;background:rgba(255,255,255,.95);padding:9px 16px;border-radius:14px;z-index:1000;font-size:14px;font-weight:800;color:#1a1a2e;box-shadow:0 2px 14px rgba(0,0,0,.12);display:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        #ai-badge{position:fixed;top:50px;left:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:4px 14px;border-radius:12px;z-index:1000;font-size:11px;font-weight:700;display:none}

        #etape-info{position:fixed;bottom:18px;left:18px;right:18px;background:#fff;border-radius:18px;padding:16px 20px;box-shadow:0 4px 28px rgba(0,0,0,.18);z-index:999;display:none;cursor:pointer}
        #etape-info-title{font-size:16px;font-weight:800;color:#1a1a2e;margin-bottom:4px}
        #etape-info-subtitle{font-size:14px;color:#667eea;font-weight:700}

        /* ===== MOONSKY BULLES ===== */
        .mk-row{display:flex;align-items:flex-end;gap:0;width:100%;max-width:360px;margin-bottom:18px}
        .mk-img{width:85px;height:85px;object-fit:contain;flex-shrink:0;filter:drop-shadow(0 3px 10px rgba(0,0,0,.45))}
        .mk-bubble{position:relative;background:rgba(255,255,255,.15);backdrop-filter:blur(12px);border:1.5px solid rgba(255,255,255,.25);border-radius:18px;padding:14px 18px;font-size:16px;font-weight:600;line-height:1.65;color:#fff;flex:1;margin-left:-4px;min-height:55px}
        .mk-bubble::before{content:'';position:absolute;left:-10px;bottom:20px;border-top:8px solid transparent;border-bottom:8px solid transparent;border-right:10px solid rgba(255,255,255,.15)}

        /* ===== OVERLAY SCREENS ===== */
        #overlay{position:fixed;top:0;left:0;right:0;bottom:0;z-index:2000;display:none;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .scr{min-height:100%;width:100%;background:linear-gradient(160deg,#0a1628 0%,#1a237e 40%,#283593 70%,#0d47a1 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:34px 26px;text-align:center;color:#fff}
        .scr.off{display:none}
        .badge{background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);padding:6px 18px;border-radius:24px;font-size:13px;font-weight:800;letter-spacing:1.2px;text-transform:uppercase;margin-bottom:18px}
        .lieu{font-size:26px;font-weight:900;margin-bottom:20px;text-shadow:0 2px 14px rgba(0,0,0,.3);line-height:1.25}

        .btn-p{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:16px 48px;border-radius:34px;font-size:18px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;box-shadow:0 4px 20px rgba(102,126,234,.4);letter-spacing:.5px}
        .btn-p:active{transform:scale(.96)}
        .btn-g{background:linear-gradient(135deg,#28a745,#20c997);color:#fff;border:none;padding:16px 48px;border-radius:34px;font-size:17px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;box-shadow:0 4px 20px rgba(40,167,69,.4)}
        .btn-o{background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.3);color:#fff;padding:14px 38px;border-radius:34px;font-size:16px;font-weight:700;font-family:'Nunito',sans-serif;cursor:pointer}

        .q-question{font-size:20px;font-weight:800;text-align:center;margin-bottom:22px;line-height:1.45;max-width:340px}
        .q-answers{width:100%;max-width:340px}
        .q-btn{display:block;width:100%;background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.25);color:#fff;padding:15px 20px;border-radius:16px;font-size:17px;font-weight:700;font-family:'Nunito',sans-serif;cursor:pointer;margin-bottom:13px;text-align:left;transition:all .2s}
        .q-btn:active{transform:scale(.97)}
        .q-btn.ok{background:rgba(40,167,69,.35);border-color:#28a745}
        .q-btn.ko{background:rgba(220,53,69,.35);border-color:#dc3545}
        .hint-box{margin-top:16px;background:rgba(255,255,255,.1);border-radius:14px;padding:14px 18px;font-size:15px;opacity:.85;max-width:340px}
        .hint-btn{background:none;border:1.5px solid rgba(255,255,255,.3);color:rgba(255,255,255,.75);padding:8px 20px;border-radius:20px;font-size:14px;font-weight:700;font-family:'Nunito',sans-serif;cursor:pointer;margin-top:14px}

        .photo-txt{font-size:19px;font-weight:700;margin-bottom:20px;line-height:1.55;max-width:330px}
        .r-emoji{font-size:60px;margin-bottom:14px}
        .r-title{font-size:26px;font-weight:900;margin-bottom:8px}
        .r-pts{font-size:38px;font-weight:900;background:linear-gradient(135deg,#ffd700,#ffaa00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:14px}
        .c-score{font-size:48px;font-weight:900;background:linear-gradient(135deg,#ffd700,#ff6b35);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px}

        .voice-btn{position:absolute;top:14px;right:14px;background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);color:#fff;width:44px;height:44px;border-radius:50%;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .voice-btn.muted{opacity:.4}

        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .anim{animation:fadeIn .4s ease-out}
        @keyframes bounceIn{0%{transform:scale(.3);opacity:0}50%{transform:scale(1.05)}70%{transform:scale(.95)}100%{transform:scale(1);opacity:1}}
        .bounce{animation:bounceIn .6s ease-out}
        @keyframes scoreUp{0%{transform:scale(1)}50%{transform:scale(1.35)}100%{transform:scale(1)}}
        .score-up{animation:scoreUp .5s ease}
    </style>
</head>
<body>

<!-- ===== LOADING SCREEN ===== -->
<div id="loading-screen">
    <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310419663030501819/OzdLzpGilysdjrSQ.png" class="ld-moonsky" alt="Moonsky"/>
    <div class="ld-title">Moonsky prepare ton aventure...</div>
    <div class="ld-city" id="ld-city">Tours</div>
    <div class="ld-bubble" id="ld-bubble"></div>
    <div class="ld-dots"><span></span><span></span><span></span></div>
</div>

<!-- ===== MAP ===== -->
<div id="map"></div>
<div id="route-title"></div>
<div id="ai-badge">&#10024; GENERE PAR IA</div>
<div id="score-badge">&#128062; <span id="score-value">0</span> pts</div>

<div id="etape-info" onclick="openEtape()">
    <div id="etape-info-title"></div>
    <div id="etape-info-subtitle">APPUYER POUR COMMENCER</div>
</div>

<!-- ===== OVERLAY ===== -->
<div id="overlay">
    <div id="scr-intro" class="scr anim" style="position:relative">
        <button class="voice-btn" id="voiceToggle" onclick="toggleVoice(event)">&#128266;</button>
        <div class="badge" id="intro-badge">ETAPE 1/5</div>
        <div class="lieu" id="intro-lieu"></div>
        <div class="mk-row">
            <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310419663030501819/OzdLzpGilysdjrSQ.png" class="mk-img" alt="Moonsky"/>
            <div class="mk-bubble" id="intro-bubble"></div>
        </div>
        <button class="btn-p" onclick="showDefi()">Lancer le defi &#127919;</button>
    </div>

    <div id="scr-quiz" class="scr off">
        <div class="badge" id="quiz-badge">&#129513; QUIZ</div>
        <div class="q-question" id="quiz-q"></div>
        <div class="q-answers" id="quiz-a"></div>
        <button class="hint-btn" onclick="toggleHint()">&#128161; Indice</button>
        <div class="hint-box" id="quiz-hint" style="display:none"></div>
    </div>

    <div id="scr-photo" class="scr off">
        <div class="badge" id="photo-badge">&#128248; DEFI PHOTO</div>
        <div class="mk-row" style="justify-content:center">
            <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310419663030501819/OzdLzpGilysdjrSQ.png" class="mk-img" alt="Moonsky"/>
            <div class="mk-bubble" id="photo-bubble"></div>
        </div>
        <div class="photo-txt" id="photo-txt"></div>
        <button class="btn-g" onclick="photoOk()">&#9989; C'est fait !</button>
    </div>

    <div id="scr-result" class="scr off">
        <div class="r-emoji" id="r-emoji">&#127881;</div>
        <div class="r-title" id="r-title">Bravo !</div>
        <div class="r-pts" id="r-pts">+100 pts</div>
        <div class="mk-row" style="justify-content:center">
            <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310419663030501819/OzdLzpGilysdjrSQ.png" class="mk-img" alt="Moonsky"/>
            <div class="mk-bubble" id="r-bubble"></div>
        </div>
        <button class="btn-p" id="btn-next" onclick="nextStep()">Etape suivante &#8594;</button>
    </div>

    <div id="scr-end" class="scr off" style="background:linear-gradient(160deg,#0a1628 0%,#0d47a1 50%,#1565c0 100%)">
        <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310419663030501819/OzdLzpGilysdjrSQ.png" class="mk-img bounce" style="width:110px;height:110px;margin-bottom:14px" alt="Moonsky"/>
        <div class="r-title" style="margin-top:10px">Parcours termine !</div>
        <div class="c-score" id="end-score">0/0</div>
        <div class="mk-row" style="justify-content:center">
            <div class="mk-bubble" id="end-bubble" style="margin-left:0"></div>
        </div>
        <button class="btn-o" onclick="backToMap()">&#128506; Retour a la carte</button>
    </div>
</div>

<script>
var WEBHOOK='https://hook.eu2.make.com/sazwwf4twy6hcfu3qckrqrl4v7hubdbl';
var DEFAULTS={duree:'Expresso',mobilite:'A pied',theme:'Decouverte',pauses:'Non',mood:'Aventurier',compo:'Duo',ville:'Tours',lat:'47.3942',lng:'0.6885'};

// ===== PARCOURS DEMO : 5 etapes rapprochees Vieux Tours =====
var DEMO={
 titre:"Secrets du Vieux Tours",
 ville:"Tours",
 introduction:"Salut aventurier ! Moi c'est Moonsky. Pret a percer les secrets du Vieux Tours ? C'est parti !",
 etapes:[
  {ordre:1,lieu_nom:"Place Plumereau",latitude:47.39485,longitude:0.68330,
   narration_arrivee:"Bienvenue sur la Place Plumereau ! C'est le coeur battant du Vieux Tours. Regarde ces magnifiques facades a colombages tout autour de toi. Savais-tu que Balzac, le celebre ecrivain, venait ici se cacher de ses creanciers ?",
   interaction:{type_interaction:"quiz",question:"Quel celebre ecrivain tourangeau se cachait de ses creanciers dans le Vieux Tours ?",reponses:["Victor Hugo","Honore de Balzac","Emile Zola","Rabelais"],bonne_reponse:1,indice:"Il a ecrit La Comedie Humaine et etait ne a Tours en 1799."},
   narration_reussite:"Excellent ! Balzac est ne a Tours en 1799. Il adorait ce quartier mais fuyait souvent ses dettes. Aujourd'hui la Place Plumereau est le spot le plus anime de la ville !",
   narration_echec:"C'etait Balzac ! Ne a Tours en 1799, il venait souvent ici. Allez, on continue !",
   points:100},
  {ordre:2,lieu_nom:"Rue du Grand Marche",latitude:47.39430,longitude:0.68450,
   narration_arrivee:"Tu es maintenant rue du Grand Marche. Cette rue medievale regorge de details caches. Fun fact : le chef etoile Olivier Arlot, originaire de Touraine, s'inspire de ces ruelles pour ses creations culinaires !",
   interaction:{type_interaction:"photo",consigne:"Trouve et photographie un detail sculpte sur une facade de cette rue. Cherche au-dessus des portes !",indice:"Leve la tete ! Les details sont souvent en hauteur, au-dessus des portes ou des fenetres."},
   narration_reussite:"Super trouvaille ! Ces details sculptes racontent l'histoire des artisans tourangeaux du XVe siecle.",
   narration_echec:"Pas de souci, ces details sont parfois bien caches !",
   points:100},
  {ordre:3,lieu_nom:"Tour Charlemagne",latitude:47.39340,longitude:0.68520,
   narration_arrivee:"Voici la Tour Charlemagne ! Ce vestige imposant de 56 metres est tout ce qui reste de l'ancienne basilique Saint-Martin. A deux pas, l'entreprise Mame, ancien fleuron de l'imprimerie tourangelle, a ete transformee en cite de la creation !",
   interaction:{type_interaction:"quiz",question:"La Tour Charlemagne doit son nom a Charlemagne. Mais pourquoi exactement ?",reponses:["Il l'a fait construire","Son epouse Luitgarde y est enterree","Il y a ete couronne","Il y a signe un traite"],bonne_reponse:1,indice:"Cherche du cote de la famille de Charlemagne et de la basilique originale."},
   narration_reussite:"Bravo ! L'epouse de Charlemagne, Luitgarde, y fut inhumee en 800. D'ou le nom ! Et juste a cote, la Cite de la Creation Mame accueille aujourd'hui des startups et artistes.",
   narration_echec:"C'est parce que Luitgarde, epouse de Charlemagne, y fut enterree en 800. Fascinant, non ?",
   points:100},
  {ordre:4,lieu_nom:"Rue Colbert",latitude:47.39380,longitude:0.68780,
   narration_arrivee:"La rue Colbert ! L'une des plus anciennes rues de Tours. Au Moyen Age, c'etait la rue principale. Aujourd'hui le basketteur Ian Mahinmi, ne a Tours, est l'une des fiertes sportives de la ville !",
   interaction:{type_interaction:"observation",consigne:"Observe les facades des numeros 39 et 41. Tu y trouveras des maisons a pans de bois avec des etages en encorbellement. Combien d'etages depassent ?",indice:"L'encorbellement, c'est quand les etages superieurs depassent par rapport au rez-de-chaussee."},
   narration_reussite:"Bien observe ! Ces encorbellements sont typiques de l'architecture medievale tourangelle. La rue Colbert est un veritable musee a ciel ouvert !",
   narration_echec:"L'encorbellement est un detail subtil. Tu le repereras mieux la prochaine fois !",
   points:100},
  {ordre:5,lieu_nom:"Place Chateauneuf",latitude:47.39420,longitude:0.68600,
   narration_arrivee:"Derniere etape : la Place Chateauneuf ! Ici se dressait la puissante basilique Saint-Martin, lieu de pelerinage majeur. Savais-tu que l'entreprise Tupperware avait son siege europeen a Tours pendant des decennies ?",
   interaction:{type_interaction:"quiz",question:"Saint Martin de Tours est celebre pour un geste legendaire. Lequel ?",reponses:["Il a construit la cathedrale","Il a partage son manteau avec un mendiant","Il a fonde l'universite","Il a repousse les Vikings"],bonne_reponse:1,indice:"C'est un geste de generosite devenu un symbole universel de partage."},
   narration_reussite:"Parfait ! Le partage du manteau est l'un des gestes les plus celebres de l'histoire de France. Bravo aventurier !",
   narration_echec:"Saint Martin a partage son manteau avec un mendiant. Un geste devenu legendaire !",
   points:100}
 ],
 conclusion:"Felicitations ! Tu as perce les secrets du Vieux Tours comme un vrai explorateur. Moonsky est super fier de toi ! A bientot pour de nouvelles aventures !"
};

var map,markers=[],polyline,parcours=null,step=0,score=0,loaded=false;
var voiceOn=true;

map=L.map('map',{center:[47.3942,0.6885],zoom:16,zoomControl:false});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OpenStreetMap'}).addTo(map);

function enc(s){return encodeURIComponent(s)}
function getP(){var p=JSON.parse(JSON.stringify(DEFAULTS));try{new URLSearchParams(location.search).forEach(function(v,k){if(v)p[k]=v})}catch(e){}try{if(location.hash){new URLSearchParams(location.hash.substring(1)).forEach(function(v,k){if(v)p[k]=v})}}catch(e){}return p}

function callWH(ok){
    var p=getP();
    var u=WEBHOOK+'?duree='+enc(p.duree)+'&mobilite='+enc(p.mobilite)+'&theme='+enc(p.theme)+'&pauses='+enc(p.pauses)+'&mood='+enc(p.mood)+'&compo='+enc(p.compo)+'&ville='+enc(p.ville)+'&lat='+enc(p.lat)+'&lng='+enc(p.lng);
    var x=new XMLHttpRequest();x.open('GET',u,true);x.timeout=120000;
    x.onload=function(){if(x.status===200&&x.responseText&&x.responseText!=='Accepted'){try{var d=parse(x.responseText);if(d&&d.etapes&&d.etapes.length>0){if(ok)ok();load(d,true);return}}catch(e){}}};
    x.onerror=x.ontimeout=function(){};x.send();
}

function parse(r){if(typeof r==='object'&&r)return norm(r);if(typeof r==='string'){var s=r.trim().replace(/\s*du module OpenAI.*$/s,'').replace(/\s*du module ChatGPT.*$/s,'');try{return norm(JSON.parse(s))}catch(e){}var i=s.indexOf('{'),j=s.lastIndexOf('}');if(i!==-1&&j>i){try{return norm(JSON.parse(s.substring(i,j+1)))}catch(e){}}}return null}
function norm(d){if(d.parcours)d=d.parcours;if(d.route)d=d.route;if(d.result){if(typeof d.result==='string'){try{d=JSON.parse(d.result)}catch(e){return null}}else d=d.result}if(!d.etapes&&d.waypoints)d.etapes=d.waypoints;if(!d.etapes&&d.steps)d.etapes=d.steps;if(d.etapes&&Array.isArray(d.etapes)){d.etapes=d.etapes.map(function(e,i){return{ordre:e.ordre||(i+1),lieu_nom:e.lieu_nom||e.name||e.lieu||e.title||('Etape '+(i+1)),latitude:parseFloat(e.latitude||e.lat),longitude:parseFloat(e.longitude||e.lng||e.lon),narration_arrivee:e.narration_arrivee||e.narration||e.description||'',interaction:normI(e.interaction||e),narration_reussite:e.narration_reussite||e.success_text||'Bravo !',narration_echec:e.narration_echec||e.failure_text||'Pas tout a fait...',points:e.points||100}})}return d}
function normI(i){if(!i)return{type_interaction:'observation',consigne:'Observe bien cet endroit !'};if(i.type_interaction)return i;if(i.question&&i.reponses)return{type_interaction:'quiz',question:i.question,reponses:i.reponses,bonne_reponse:i.bonne_reponse||0,indice:i.indice||''};if(i.consigne)return{type_interaction:i.type||'observation',consigne:i.consigne,indice:i.indice||''};return{type_interaction:'observation',consigne:'Observe bien cet endroit !'}}

function ico(n,a){return L.divIcon({className:'x',iconSize:[38,38],iconAnchor:[19,19],html:'<div style="width:38px;height:38px;border-radius:50%;background:'+(a?'linear-gradient(135deg,#667eea,#764ba2)':'#bbb')+';color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;box-shadow:0 2px 12px rgba(0,0,0,.35);border:3px solid #fff;font-family:Nunito,sans-serif">'+n+'</div>'})}
function doneIco(){return L.divIcon({className:'x',iconSize:[38,38],iconAnchor:[19,19],html:'<div style="width:38px;height:38px;border-radius:50%;background:#28a745;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;box-shadow:0 2px 12px rgba(0,0,0,.35);border:3px solid #fff">&#10003;</div>'})}

// ===== MOONSKY PARLE (texte + voix) =====
function speak(id,txt,cb){
    var el=document.getElementById(id);if(!el)return;el.textContent='';
    if(voiceOn&&'speechSynthesis' in window){
        window.speechSynthesis.cancel();
        var u=new SpeechSynthesisUtterance(txt);
        u.lang='fr-FR';u.rate=1.05;u.pitch=1.1;
        var voices=window.speechSynthesis.getVoices();
        for(var v=0;v<voices.length;v++){if(voices[v].lang.indexOf('fr')===0){u.voice=voices[v];break}}
        window.speechSynthesis.speak(u);
    }
    var i=0,sp=22;
    (function t(){if(i<txt.length){el.textContent+=txt.charAt(i);i++;setTimeout(t,sp)}else{if(cb)cb()}})();
}

function toggleVoice(e){
    e.stopPropagation();voiceOn=!voiceOn;
    document.getElementById('voiceToggle').textContent=voiceOn?'\u{1F50A}':'\u{1F507}';
    document.getElementById('voiceToggle').classList.toggle('muted',!voiceOn);
    if(!voiceOn&&'speechSynthesis' in window)window.speechSynthesis.cancel();
}

// ===== LOAD PARCOURS =====
function load(data,ai){
    if(typeof data==='string'){try{data=JSON.parse(data)}catch(e){return}}
    if(loaded&&ai&&score>0)return;
    parcours=data;step=0;score=0;loaded=true;
    document.getElementById('score-value').textContent='0';
    if(parcours.titre){var t=document.getElementById('route-title');t.textContent=parcours.titre;t.style.display='block'}
    document.getElementById('score-badge').style.display='block';
    if(ai)document.getElementById('ai-badge').style.display='block';
    markers.forEach(function(m){map.removeLayer(m)});markers=[];
    if(polyline)map.removeLayer(polyline);
    var ll=[];
    parcours.etapes.forEach(function(e,i){
        var la=parseFloat(e.latitude),lo=parseFloat(e.longitude);if(isNaN(la)||isNaN(lo))return;
        var p=[la,lo];ll.push(p);
        var m=L.marker(p,{icon:ico(i+1,i===0)}).addTo(map);
        m.bindTooltip(e.lieu_nom,{permanent:false,direction:'top',offset:[0,-24],className:'tooltip-custom'});
        (function(idx){m.on('click',function(){step=idx;updInfo(idx)})})(i);
        markers.push(m);
    });
    if(!ll.length)return;
    polyline=L.polyline(ll,{color:'#667eea',weight:4,opacity:.7,dashArray:'8,8'}).addTo(map);
    map.fitBounds(L.latLngBounds(ll).pad(.15));
    updInfo(0);
}

function updInfo(i){
    var e=parcours.etapes[i],ty=(e.interaction.type_interaction||'defi').toUpperCase();
    if(ty==='QUIZ')ty='QUIZ';else if(ty==='PHOTO')ty='PHOTO';else ty='OBSERVATION';
    document.getElementById('etape-info-title').textContent='Etape '+(i+1)+'/'+parcours.etapes.length+' - '+e.lieu_nom;
    document.getElementById('etape-info-subtitle').textContent=ty+' - Appuyer pour voir';
    document.getElementById('etape-info').style.display='block';
}

function showScr(id){['scr-intro','scr-quiz','scr-photo','scr-result','scr-end'].forEach(function(s){var el=document.getElementById(s);el.classList.add('off');el.style.display='none'});var el=document.getElementById(id);el.classList.remove('off');el.style.display='flex';el.className=el.className.replace(' anim','')+' anim'}

function openEtape(){
    var e=parcours.etapes[step];
    showScr('scr-intro');
    document.getElementById('intro-badge').textContent='ETAPE '+(step+1)+'/'+parcours.etapes.length;
    document.getElementById('intro-lieu').textContent=e.lieu_nom;
    document.getElementById('overlay').style.display='flex';
    document.getElementById('overlay').scrollTop=0;
    speak('intro-bubble',e.narration_arrivee);
    map.flyTo([e.latitude,e.longitude],17,{duration:1});
    markers.forEach(function(m,i){if(i<step)m.setIcon(doneIco());else if(i===step)m.setIcon(ico(i+1,true));else m.setIcon(ico(i+1,false))});
}

function showDefi(){
    if('speechSynthesis' in window)window.speechSynthesis.cancel();
    var e=parcours.etapes[step],ty=(e.interaction.type_interaction||'observation').toLowerCase();
    if(ty==='quiz')doQuiz(e);else doPhoto(e);
}

function doQuiz(e){
    showScr('scr-quiz');
    document.getElementById('quiz-q').textContent=e.interaction.question||e.interaction.consigne||'Question...';
    document.getElementById('quiz-hint').textContent=(e.interaction.indice||'Observe bien autour de toi !');
    document.getElementById('quiz-hint').style.display='none';
    var ad=document.getElementById('quiz-a');ad.innerHTML='';
    var reps=e.interaction.reponses||[],bon=parseInt(e.interaction.bonne_reponse)||0;
    if(!reps.length){var b=document.createElement('button');b.className='btn-p';b.textContent="J'ai trouve !";b.style.marginTop='20px';b.onclick=function(){result(true,e)};ad.appendChild(b);return}
    reps.forEach(function(r,idx){
        var b=document.createElement('button');b.className='q-btn';b.textContent=r;
        b.onclick=function(){
            var all=ad.querySelectorAll('.q-btn');all.forEach(function(x){x.style.pointerEvents='none'});
            if(idx===bon){b.classList.add('ok');setTimeout(function(){result(true,e)},800)}
            else{b.classList.add('ko');all[bon].classList.add('ok');setTimeout(function(){result(false,e)},1200)}
        };ad.appendChild(b);
    });
}

function doPhoto(e){
    showScr('scr-photo');
    var ty=(e.interaction.type_interaction||'observation').toLowerCase();
    document.getElementById('photo-badge').textContent=ty==='photo'?'DEFI PHOTO':'OBSERVATION';
    document.getElementById('photo-txt').textContent=e.interaction.consigne||e.interaction.question||'Observe bien cet endroit !';
    speak('photo-bubble',e.interaction.indice||'Prends ton temps et observe bien !');
}
function photoOk(){if('speechSynthesis' in window)window.speechSynthesis.cancel();result(true,parcours.etapes[step])}
function toggleHint(){var h=document.getElementById('quiz-hint');h.style.display=h.style.display==='none'?'block':'none'}

function result(ok,e){
    if('speechSynthesis' in window)window.speechSynthesis.cancel();
    showScr('scr-result');
    var pts=ok?(e.points||100):0;score+=pts;
    document.getElementById('score-value').textContent=score;
    var badge=document.getElementById('score-badge');badge.classList.remove('score-up');void badge.offsetWidth;badge.classList.add('score-up');
    document.getElementById('r-emoji').textContent=ok?'\u{1F389}':'\u{1F605}';
    document.getElementById('r-title').textContent=ok?'Bravo !':'Pas cette fois...';
    document.getElementById('r-pts').textContent=ok?'+'+pts+' pts':'+0 pts';
    speak('r-bubble',ok?e.narration_reussite:e.narration_echec);
    if(step<markers.length)markers[step].setIcon(doneIco());
    var last=step>=parcours.etapes.length-1;
    document.getElementById('btn-next').textContent=last?'Resultat final':'Etape suivante';
}

function nextStep(){
    if('speechSynthesis' in window)window.speechSynthesis.cancel();
    if(step>=parcours.etapes.length-1){showEnd();return}
    step++;
    document.getElementById('overlay').style.display='none';
    updInfo(step);
    var e=parcours.etapes[step];
    map.flyTo([e.latitude,e.longitude],17,{duration:1.2});
    markers.forEach(function(m,i){if(i<step)m.setIcon(doneIco());else if(i===step)m.setIcon(ico(i+1,true));else m.setIcon(ico(i+1,false))});
}

function showEnd(){
    showScr('scr-end');
    var mx=parcours.etapes.length*100;
    document.getElementById('end-score').textContent=score+' / '+mx+' pts';
    speak('end-bubble',parcours.conclusion||'Bravo aventurier ! Tu as termine ce parcours avec brio !');
}
function backToMap(){
    if('speechSynthesis' in window)window.speechSynthesis.cancel();
    document.getElementById('overlay').style.display='none';
    document.getElementById('etape-info').style.display='none';
    var ll=parcours.etapes.map(function(e){return[e.latitude,e.longitude]});
    map.fitBounds(L.latLngBounds(ll).pad(.15));
}

if('speechSynthesis' in window){window.speechSynthesis.onvoiceschanged=function(){window.speechSynthesis.getVoices()}}

// ===== LOADING SCREEN FUN =====
var LD_PHRASES=[
    "Je fouille dans mes archives secretes...",
    "Je demande aux pigeons locaux les meilleurs spots...",
    "Je negocie avec l'IA pour des enigmes de folie...",
    "Je verifie que les fantomes du quartier sont cool...",
    "Je calcule l'itineraire parfait pour tes pattes...",
    "Je prepare des defis qui vont te surprendre...",
    "Patience, la magie opere...",
    "Je consulte les anciens de la ville...",
    "Encore quelques secondes, ca va etre genial !",
    "Je cache des indices un peu partout..."
];
var ldIdx=0,ldTimer=null;

function startLoading(){
    var p=getP();
    var el=document.getElementById('ld-city');
    if(el)el.textContent=p.ville||'Tours';
    typeLd();
    ldTimer=setInterval(typeLd,3500);
}

function typeLd(){
    var el=document.getElementById('ld-bubble');if(!el)return;
    var txt=LD_PHRASES[ldIdx%LD_PHRASES.length];ldIdx++;
    el.textContent='';
    var i=0;
    (function t(){if(i<txt.length){el.textContent+=txt.charAt(i);i++;setTimeout(t,28)}})();
}

function hideLoading(){
    if(ldTimer)clearInterval(ldTimer);
    var ls=document.getElementById('loading-screen');
    if(ls){ls.classList.add('hide');setTimeout(function(){ls.style.display='none'},600)}
}

// ===== START =====
(function(){
    console.log('[Explozill] v8 final');
    startLoading();
    var done=false;
    var t=setTimeout(function(){if(!done){done=true;hideLoading();load(DEMO,false)}},45000);
    callWH(function(){done=true;clearTimeout(t);hideLoading()});
})();
</script>
</body>
</html>
